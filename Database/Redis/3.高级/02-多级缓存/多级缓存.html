<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.17" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.58" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <title>多级缓存 | 小满</title><meta name="description" content="小满的知识库">
    <link rel="stylesheet" href="/blog/assets/css/styles.50e9a4d3.css">
    <link rel="preload" href="/blog/assets/js/runtime~app.f8e82470.js" as="script"><link rel="preload" href="/blog/assets/css/styles.50e9a4d3.css" as="style"><link rel="preload" href="/blog/assets/js/9703.e09ff620.js" as="script"><link rel="preload" href="/blog/assets/js/app.46b02cbe.js" as="script">
    <link rel="prefetch" href="/blog/assets/js/Database_Redis_2.实战_Redis实战篇.html.ef4d662e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_4.Netty04-优化与源码.html.e7d40ecf.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_2.NIO 基础.html.4b35293b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_3.Netty03-进阶.html.af54bd22.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_3.Netty02-入门.html.9e803486.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_35.反射_动态代理.html.66d0420a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_Redis高级篇-多级缓存_多级缓存.html.ff471cbf.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_02-多级缓存_多级缓存.html.ecb62863.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_讲义-分布式搜索引擎02.html.670b1109.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_1.入门_Redis基础篇.html.cbfb5db8.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_讲义-分布式搜索引擎01.html.e242bc87.js" as="script"><link rel="prefetch" href="/blog/assets/js/装机_Intel桌面处理器规格.html.8fe5fdbb.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_4.原理_原理篇.html.758beea0.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_MQ_RabbitMQ.html.40bde5f3.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_Redis高级篇-最佳实践_Redis高级篇之最佳实践.html.2122d85a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_03-Redis最佳实践_Redis高级篇之最佳实践.html.9b30173f.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Sentinel_微服务保护.html.db597981.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_基础_核心数据类型.html.d7927650.js" as="script"><link rel="prefetch" href="/blog/assets/js/装机_AMD桌面处理器规格.html.22ad0ed3.js" as="script"><link rel="prefetch" href="/blog/assets/js/Vue_表单验证.html.c7b276b8.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_4.安装elasticsearch.html.8d8e6057.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_Java Stream API.html.4efc941a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_函数式接口.html.fe5525e1.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_爬虫_样例.html.955ab32a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_1.补充- FST框架使用.html.8eefff4c.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@ControllerAdvice.html.88139954.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_深入理解 Stream API.html.247546e7.js" as="script"><link rel="prefetch" href="/blog/assets/js/849.830c18d2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_Redis高级篇-分布式缓存_Redis高级-分布式缓存.html.1d2afb10.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_01-分布式缓存_Redis高级-分布式缓存.html.c579ebea.js" as="script"><link rel="prefetch" href="/blog/assets/js/8300.ff153695.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_Channel.html.7d9b251b.js" as="script"><link rel="prefetch" href="/blog/assets/js/4214.394da83e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_基础_2-函数.html.b780334a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring MVC_校验_Hibernate Validator.html.dc878077.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_深入理解 Java Collector.html.fb721c96.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_板书_数据校验.html.a342e2e6.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_私有云_玩客云.html.54bffb95.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_注解_@TableField.html.4ff8f1fe.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring MVC_校验_自定义校验.html.25b66c54.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_3.扩展-异常处理注意点.html.e09cf2e0.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_接口_MetaObjectHandler接口文档.html.58046c57.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_8.常见查询类型.html.ff1723d9.js" as="script"><link rel="prefetch" href="/blog/assets/js/emoji.html.656320bc.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@InitBinder.html.54afd16f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_17.JDK动态代理和CGLIB动态代理有什么区别.html.a4fb73e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_深入理解 Java 中的默认方法和静态方法.html.54b57a4e.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_测试方法启动空指针.html.5ab61648.js" as="script"><link rel="prefetch" href="/blog/assets/js/设计模式_代理模式.html.639d603d.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_元注解.html.a0d90a67.js" as="script"><link rel="prefetch" href="/blog/assets/js/611.5fb33018.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_jstack用法.html.0ddc2402.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Alibaba-OSS_阿里云oss使用记录.html.eaef8d41.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_接口_MetaObjectHandler示例.html.560152b8.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring MVC_校验_JSR303数字校验.html.2f47c9fd.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@EnableTransactionManagement.html.f5529fd0.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_2.5方法区.html.44e8826c.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_深入理解 Java Optional 类.html.9102eae7.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_this.page().html.a9c61512.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_深入理解 Java 8 新特性：从核心到实践.html.459ddbe5.js" as="script"><link rel="prefetch" href="/blog/assets/js/Vue_vue模板.html.7e5d8ddf.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_反射.html.a4909ce0.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_16.什么是Java中的动态代理.html.5d16e894.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_5.什么是Java的多态.html.a617b902.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_基础_1-数据库控制语言DCL.html.61820032.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_2.6直接内存.html.8fab97ed.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_7.Java 不支持多重继承.html.ea5c7452.js" as="script"><link rel="prefetch" href="/blog/assets/js/7583.2af54276.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Jmeter_3.sentinel规则持久化.html.96a3b01d.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_6.Java中的参数传递是按值还是按引用.html.9a101d1e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_wrapper.and().html.8316c195.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Nacos_2.配置中心.html.aff6406f.js" as="script"><link rel="prefetch" href="/blog/assets/js/7096.76bb9882.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_异常_try-with-resources自动关闭资源.html.c0f5e20e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_8.Java面向对象和面向过程编程的区别.html.4a574a8b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_9.Java方法重载和重写之间的区别.html.3b51d378.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_11.Java8新特性.html.2a755e18.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_10.分页.html.f3208d7c.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_init命令详解.html.6eddb804.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_查看系统配置.html.20946ee0.js" as="script"><link rel="prefetch" href="/blog/assets/js/Bug_maven刷新时语言基本重置问题.html.2a12ea41.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_MQ_安装_RabbitMQ部署指南.html.bc8c0873.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_查询安装位置.html.b8eefb00.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_查看镜像架构.html.10357f4f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_15.Java中的hashCode和equals方法之间有什么关系.html.2e932c71.js" as="script"><link rel="prefetch" href="/blog/assets/js/装机_电脑装机进阶.html.5e9be82c.js" as="script"><link rel="prefetch" href="/blog/assets/js/7124.11cc5132.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_Docker构建SpringBoot镜像.html.1153102f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_Junit_生命周期注解.html.1bdb2e35.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_数据库安全配置.html.e376f41b.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_人人后台注册至Nacos版本问题.html.af926e49.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_镜像导入导出.html.5f253910.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_9.copy_to的用法.html.7ebddff9.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_API_API.html.b6083a6f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_私有云_私有云部署软件.html.3c90a77e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_MySQL8.0安装.html.4525ff6e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_getMethods()和getDeclaredMethods()的区别.html.dd711d53.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_新版分页插件.html.02583fc7.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@FeignClient.html.8131e0f8.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_getDeclaredField()和getField()区别.html.a09b9582.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_Docker容器与宿主机时间同步.html.1fc5ee0a.js" as="script"><link rel="prefetch" href="/blog/assets/js/VCS_Git_本地项目推送至远程库.html.d6f5baa6.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_Navicat连接mysql报错.html.512c7bbd.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_数据库隔离级别.html.7eee0d67.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_硬盘挂载.html.62094ba5.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_cpu load过高问题.html.45b4ecb3.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_释放ByteBuf.html.44e0a802.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_注解@RequestMapping、@PostMapping、@GetMapping.html.f404d701.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Jmeter_1.MAC安装JMeter.html.3ad79ae1.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_7.创建索引库.html.33a666de.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_私有云_前后端分离博客项目.html.0a2379dd.js" as="script"><link rel="prefetch" href="/blog/assets/js/Kafka_发送接收demo.html.9d3492c6.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_14.Java 中 hashCode_equals 方法和__ 操作符.html.d108af7c.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_systemctl.html.943b2d37.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_GC类型.html.aa160a2c.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_1.什么是ES.html.58a2950c.js" as="script"><link rel="prefetch" href="/blog/assets/js/1434.900263ce.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_OOM.html.f16ec43b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_MySQL 数据库授权管理.html.4e618597.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_4.Java的优势.html.485203fd.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_关闭事件循环组.html.b6361960.js" as="script"><link rel="prefetch" href="/blog/assets/js/1316.26df1e75.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_核心概念理解.html.54df7095.js" as="script"><link rel="prefetch" href="/blog/assets/js/2275.dcc4168e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_软硬链接.html.9a9c74bb.js" as="script"><link rel="prefetch" href="/blog/assets/js/1317.10732497.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_10.Java内部类及作用.html.e3805bef.js" as="script"><link rel="prefetch" href="/blog/assets/js/6873.b44a0bdd.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Nacos_3.网关配置.html.eb8419ea.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_12.JDK和JRE区别.html.2fbbf32e.js" as="script"><link rel="prefetch" href="/blog/assets/js/网络_L2TP和IPsec协议常见软件和工具.html.c2b212ad.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_pull.html.13c45d2c.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_union和union all.html.337c3a6d.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_SpringBoot无数据源启动.html.acf02851.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Jmeter_2.Jmeter快速入门.html.c67db61b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_Ubuntu命令行图形化界面切换.html.2bb8174e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis_逻辑删除.html.5fbb6102.js" as="script"><link rel="prefetch" href="/blog/assets/js/5663.892fda56.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_API_ExecutorService.html.48a71b7f.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_关闭eslint检查.html.18380527.js" as="script"><link rel="prefetch" href="/blog/assets/js/网络_L2TPIPsec.html.6d3280c8.js" as="script"><link rel="prefetch" href="/blog/assets/js/VCS_Git_忽略文件夹.html.ac495ac2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@ResponseBody.html.45cbaf09.js" as="script"><link rel="prefetch" href="/blog/assets/js/1901.74b1b7c6.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_人人前端启动失败.html.7897e455.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_dos2unix换行符清理.html.bb57a70f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_特权模式.html.b54d6ec1.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_单用户模式重置密码.html.0a1cbbe6.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_7.Java不支持多重继承.html.c4aab9e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.1.年轻代老年代.html.1042ed71.js" as="script"><link rel="prefetch" href="/blog/assets/js/Nginx_413 (Request Entity Too Large).html.912e4bfe.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@JsonFormat.html.19e18701.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_1.序列化与反序列化.html.ac0204f4.js" as="script"><link rel="prefetch" href="/blog/assets/js/装机_电脑配置.html.2d433981.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_2.2虚拟机栈.html.5fd3fbaa.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_mysql -uroot -p报错.html.1969cf2a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_字节码对象.html.fd7eca29.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_安装NocoDB.html.da927285.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_主要架构.html.fba20772.js" as="script"><link rel="prefetch" href="/blog/assets/js/5292.04bf372b.js" as="script"><link rel="prefetch" href="/blog/assets/js/网络_刷新dns缓存.html.58ebd8d2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_caching_sha2_password无法加载.html.44c79a37.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_动态构建查询条件.html.6af3a6bd.js" as="script"><link rel="prefetch" href="/blog/assets/js/前端_node_nvm更换镜像源.html.b2acda58.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_2.不可变类.html.9648a76a.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_13.你使用过哪些JDK工具.html.5487d6d4.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_QueryWrapper vs LambdaQueryWrapper.html.1bbe33c9.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_3.基本概念.html.660d0325.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Nacos_0.安装与启动.html.127ff4b2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_queryWrapper自定义SQL.html.d29425b9.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_安装Nginx.html.5bc94679.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_3.Exception和Error的区别.html.642943ab.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_Spring5.x概述.html.146e06b2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_where 1_1.html.e7ba1354.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_基础_0.前言.html.acc52c21.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_2.3本地方法栈.html.b1c87b2f.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Nacos_1.注册中心.html.01db50f3.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_2.1程序计数器.html.58e42edd.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_daemon-reload.html.52c2b3c8.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_REAME.html.1987848d.js" as="script"><link rel="prefetch" href="/blog/assets/js/前端_node_npm更换镜像源.html.03210df9.js" as="script"><link rel="prefetch" href="/blog/assets/js/4903.a7f55910.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_唯手熟尔_equals与等号.html.ea8205fc.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_跨域.html.3ca09a15.js" as="script"><link rel="prefetch" href="/blog/assets/js/2916.54fd14b9.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_rc.local.html.dce6a976.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_5.分词器.html.906079c0.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_2.4堆.html.3d47aef7.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_空值和null值.html.28428b3b.js" as="script"><link rel="prefetch" href="/blog/assets/js/2240.bce1f31c.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构.html.777fb4bd.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Nacos_4.Nacos指定服务端IP.html.ddbe5bb4.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_reset-failed.html.8cb1a230.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_1.学习JVM有什么用.html.3fd418be.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_6.mapping常见属性.html.16cc740c.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_定时任务启动失败.html.c9ede50f.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_2.倒排索引.html.34dc3c09.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Sentinel_bug_windows版sentinel运行报错问题处理Unable to make protected final java.lang.Class java.lang.ClassLoader.define.html.25d50431.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_String_isNotEmpty和isNotBlank.html.369d75b1.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_SpringBoot读取ValidationMessages.properties，中文乱码.html.80534b5d.js" as="script"><link rel="prefetch" href="/blog/assets/js/装机_飞牛OS开关屏幕.html.df8a90f8.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_找不到符号.html.513b96a5.js" as="script"><link rel="prefetch" href="/blog/assets/js/Vue_index.html.ef46c87d.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_服务列表为空.html.886f08cd.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_视频教程.html.2907938f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_index.html.66480ff7.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_index.html.321cad3e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_视频教程.html.c9df6dec.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_视频教程.html.3ab2596f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_1.黑马视频教程.html.7e82ef4b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_雷丰阳Java视频.html.624075ac.js" as="script"><link rel="prefetch" href="/blog/assets/js/index.html.adacdc5f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_@JsonInclude.html.653d1397.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_黑马JVM.html.b85683b8.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_总结-反射.html.971bb632.js" as="script"><link rel="prefetch" href="/blog/assets/js/676.f6b4bdac.js" as="script"><link rel="prefetch" href="/blog/assets/js/3021.ce68dc19.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_基础_video.html.9b030552.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_查看数据卷目录.html.b5028198.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_index.html.fceca5fa.js" as="script"><link rel="prefetch" href="/blog/assets/js/3160.07cf795c.js" as="script"><link rel="prefetch" href="/blog/assets/js/intro.html.eb10c17a.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Nacos_index.html.aa010d8d.js" as="script"><link rel="prefetch" href="/blog/assets/js/8984.f327bcec.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_Redis高级篇-分布式缓存_index.html.9f779adb.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_Redis高级篇-多级缓存_index.html.0db87aa4.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_Redis高级篇-最佳实践_index.html.35046b76.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_35.反射_动态代理_index.html.7900a388.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_使用指南_index.html.15682873.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_基础知识_index.html.d9dca968.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_接口文档_index.html.2bf0a2c9.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_网络编程_index.html.8b878662.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_接口示例_index.html.78dafb18.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_报错记录_index.html.0c1a0ad9.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_中间件_index.html.f2830b49.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_数据库_index.html.83e606c4.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_mybatis-plus_index.html.553ee89d.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_java8特性_index.html.778a77f2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_01-分布式缓存_index.html.5ca25fee.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_03-Redis最佳实践_index.html.cec32d66.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_私有云_index.html.d8414901.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_实战_index.html.c09924e0.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_装机_index.html.93f0c6fb.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_项目_index.html.bf862a53.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_网络_index.html.d970dca5.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_se基础_index.html.6d85fb36.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_index.html.4489feaa.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_markdown_index.html.162868dd.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_02-多级缓存_index.html.908be1fb.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_谷粒商城_板书_index.html.9c5f3e8b.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_mybatis_index.html.73643351.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_事务_index.html.c225d2f9.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_使用_index.html.38cceecc.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_入门_index.html.6147ae8a.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_反射_index.html.e35de83b.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_命令_index.html.41af61e5.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_坑王_index.html.739d7035.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_基础_index.html.db72b8f5.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_安全_index.html.5dac244d.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_安装_index.html.12b854af.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_容器_index.html.d31799bc.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_必背_index.html.6f933a9f.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_总结_index.html.4680839b.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_教程_index.html.8d1430cd.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_查询_index.html.8bf196b3.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_爬虫_index.html.21da8848.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_经验_index.html.974ff28a.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_网络_index.html.8b8ee87a.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_装机_index.html.ba26b8cb.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_踩坑_index.html.c63ad2d7.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_重点_index.html.59ce28cd.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_镜像_index.html.0e33acf4.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_了解_index.html.d4aa36ec.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_插件_index.html.16f4eb57.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_注解_index.html.5aade75e.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_讲义_index.html.9e7218df.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_docker_index.html.2e14cb66.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_python_index.html.b951ceee.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_spring_index.html.2fdc451d.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_linux_index.html.8a4f9501.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_mysql_index.html.f44858d2.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_nacos_index.html.c1176a12.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_netty_index.html.596d6814.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_nginx_index.html.f79a37ec.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_index.html.02d091d6.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_index.html.b458862f.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_redis_index.html.a0c14348.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_java_index.html.26ea9dad.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_git_index.html.18e44b64.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_vue_index.html.10b01273.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_error_index.html.1a92c661.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_jvm_index.html.1e172f72.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_es_index.html.51e56dde.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_入门到起飞_index.html.374fb090.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_index.html.7d26b6ae.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_bug_index.html.832a7460.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_git_index.html.1b7b423e.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_api_index.html.9a33c798.js" as="script"><link rel="prefetch" href="/blog/assets/js/Linux_index.html.8a714ffc.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_index.html.7712d32e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Nginx_index.html.7ec5b5ac.js" as="script"><link rel="prefetch" href="/blog/assets/js/5152.9b4917b0.js" as="script"><link rel="prefetch" href="/blog/assets/js/JVM_2.内存结构_index.html.5a87fb04.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_唯手熟尔_index.html.55c9f4f4.js" as="script"><link rel="prefetch" href="/blog/assets/js/category_index.html.6d98fdff.js" as="script"><link rel="prefetch" href="/blog/assets/js/项目实战_index.html.43097ba4.js" as="script"><link rel="prefetch" href="/blog/assets/js/timeline_index.html.e240e64f.js" as="script"><link rel="prefetch" href="/blog/assets/js/设计模式_index.html.01c227ed.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Sentinel_index.html.3ce284cb.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_index.html.1c24ae43.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_接口_index.html.930c6bbc.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_注解_index.html.c3dc67cf.js" as="script"><link rel="prefetch" href="/blog/assets/js/Docker_私有云_index.html.63a173fa.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_2.实战_index.html.90f3d437.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_3.高级_index.html.29b8dd98.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_4.原理_index.html.aaea0fa5.js" as="script"><link rel="prefetch" href="/blog/assets/js/tag_index.html.2856d096.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_Redis_1.入门_index.html.dd0f0619.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_Java8特性_index.html.d72cbe6b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_面试题_index.html.acf47f33.js" as="script"><link rel="prefetch" href="/blog/assets/js/article_index.html.751f09ca.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Jmeter_index.html.fd0065c0.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_Sentinel_bug_index.html.c21a58e4.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis Plus_index.html.8a0b7e52.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_Alibaba-OSS_index.html.80eb9229.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_MQ_安装_index.html.ab80e7bf.js" as="script"><link rel="prefetch" href="/blog/assets/js/star_index.html.5be1e703.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_MySQL_基础_index.html.88420d5f.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring MVC_校验_index.html.75ad0031.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_高级_index.html.2b2f3041.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_基础_index.html.8e89b3e3.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_注解_index.html.f1c61be8.js" as="script"><link rel="prefetch" href="/blog/assets/js/Python_爬虫_index.html.9ec4840d.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_异常_index.html.1a9a195d.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_index.html.07481e8e.js" as="script"><link rel="prefetch" href="/blog/assets/js/前端_node_index.html.2d0eb6ef.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring MVC_index.html.e14ffd3a.js" as="script"><link rel="prefetch" href="/blog/assets/js/前端_index.html.2ae3735e.js" as="script"><link rel="prefetch" href="/blog/assets/js/网络_index.html.d6e74500.js" as="script"><link rel="prefetch" href="/blog/assets/js/装机_index.html.33575e43.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_Mybatis_index.html.9590d4b2.js" as="script"><link rel="prefetch" href="/blog/assets/js/Database_index.html.eba4d359.js" as="script"><link rel="prefetch" href="/blog/assets/js/Java_String_index.html.23f21b58.js" as="script"><link rel="prefetch" href="/blog/assets/js/Mybatis_index.html.9686664e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Spring_Junit_index.html.9f6c55e3.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_ES_index.html.42ab127b.js" as="script"><link rel="prefetch" href="/blog/assets/js/SpringCloud_MQ_index.html.cd93d751.js" as="script"><link rel="prefetch" href="/blog/assets/js/Netty_API_index.html.f35cb00b.js" as="script"><link rel="prefetch" href="/blog/assets/js/Kafka_index.html.45d3f2ae.js" as="script"><link rel="prefetch" href="/blog/assets/js/VCS_Git_index.html.333fcf10.js" as="script"><link rel="prefetch" href="/blog/assets/js/VCS_index.html.41c61607.js" as="script"><link rel="prefetch" href="/blog/assets/js/404.html.bc037f5e.js" as="script"><link rel="prefetch" href="/blog/assets/js/Bug_index.html.60f880e4.js" as="script"><link rel="prefetch" href="/blog/assets/js/2666.71fedeaa.js" as="script"><link rel="prefetch" href="/blog/assets/js/8070.f013b580.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/blog/" aria-label="带我回家"><img class="vp-nav-logo" src="/blog/assets/images/avatar.png" alt><!----><span class="vp-site-name hide-in-pad">小满</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/" aria-label="主页"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="后端"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-code" style=""></span>后端<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/Java/" aria-label="Java"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-java" style=""></span><!--]-->Java<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/Python/" aria-label="Python"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-python" style=""></span><!--]-->Python<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/JVM/" aria-label="JVM"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-microchip" style=""></span><!--]-->JVM<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/Vue/" aria-label="Vue"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-vuejs" style=""></span><!--]-->Vue<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Spring"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-leaf" style=""></span>Spring<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/Spring/" aria-label="Spring"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-leaf" style=""></span><!--]-->Spring<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="SpringCloud"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-cloud" style=""></span>SpringCloud<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/SpringCloud/Nacos/" aria-label="Nacos"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-cloud" style=""></span><!--]-->Nacos<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/SpringCloud/ES/" aria-label="ES"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-searchengin" style=""></span><!--]-->ES<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/SpringCloud/%E9%AB%98%E7%BA%A7/" aria-label="高级篇"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-web-awesome" style=""></span><!--]-->高级篇<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="数据库"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-database" style=""></span>数据库<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/Database/MySQL/" aria-label="MySQL"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-database" style=""></span><!--]-->MySQL<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/Database/Redis/" aria-label="Redis"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-server" style=""></span><!--]-->Redis<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/Docker/" aria-label="Docker"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-docker" style=""></span><!--]-->Docker<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Linux"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-linux" style=""></span>Linux<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/Linux/" aria-label="Linux"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-linux" style=""></span><!--]-->Linux<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/Netty/" aria-label="Netty"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-n" style=""></span><!--]-->Netty<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="项目实战"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-product-hunt" style=""></span>项目实战<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/blog/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" aria-label="谷粒商城"><!--[--><span class="font-icon icon fa-fw fa-sm fa-brands fa-codepen" style=""></span><!--]-->谷粒商城<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="auto-link external-link" href="http://blog.xiaoxiongmaococo.com:92/#/" aria-label="blog" rel="noopener noreferrer" target="_blank"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-blog" style=""></span><!--]-->blog<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/JL-20191210/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">MySQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Redis</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/blog/Database/Redis/" aria-label="Redis"><!---->Redis<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">1.入门</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">2.实战</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">3.高级</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">01 分布式缓存</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">02 多级缓存</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/blog/Database/Redis/3.%E9%AB%98%E7%BA%A7/02-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98.html" aria-label="多级缓存"><!---->多级缓存<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">03 Redis最佳实践</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Redis高级篇 最佳实践</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Redis高级篇 分布式缓存</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Redis高级篇 多级缓存</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">4.原理</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/blog/Database/Redis/%E8%A7%86%E9%A2%91%E6%95%99%E7%A8%8B.html" aria-label="视频教程"><!--[--><span class="font-icon icon fa-fw fa-sm fa-solid fa-play" style=""></span><!--]-->视频教程<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->多级缓存</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">来杯冰柠檬</span></span><span property="author" content="来杯冰柠檬"></span></span><!----><!----><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 29 分钟</span><meta property="timeRequired" content="PT29M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-1-导入案例">2.1.导入案例</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-2-初识caffeine">2.2.初识Caffeine</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-3-实现jvm进程缓存">2.3.实现JVM进程缓存</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-3-1-需求">2.3.1.需求</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-3-2-实现">2.3.2.实现</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-1-初识lua">3.1.初识Lua</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-1-helloworld">3.1.HelloWorld</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-2-变量和循环">3.2.变量和循环</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-2-1-lua的数据类型">3.2.1.Lua的数据类型</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-2-2-声明变量">3.2.2.声明变量</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-2-3-循环">3.2.3.循环</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-3-条件控制、函数">3.3.条件控制、函数</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3-1-函数">3.3.1.函数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3-2-条件控制">3.3.2.条件控制</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-3-3-案例">3.3.3.案例</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-1-安装openresty">4.1.安装OpenResty</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-2-openresty快速入门">4.2.OpenResty快速入门</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-2-1-反向代理流程">4.2.1.反向代理流程</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-2-2-openresty监听请求">4.2.2.OpenResty监听请求</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-2-3-编写item-lua">4.2.3.编写item.lua</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-3-请求参数处理">4.3.请求参数处理</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-3-1-获取参数的api">4.3.1.获取参数的API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-3-2-获取参数并返回">4.3.2.获取参数并返回</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-4-查询tomcat">4.4.查询Tomcat</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-4-1-发送http请求的api">4.4.1.发送http请求的API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-4-2-封装http工具">4.4.2.封装http工具</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-4-3-cjson工具类">4.4.3.CJSON工具类</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-4-4-实现tomcat查询">4.4.4.实现Tomcat查询</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-4-5-基于id负载均衡">4.4.5.基于ID负载均衡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-5-redis缓存预热">4.5.Redis缓存预热</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-6-查询redis缓存">4.6.查询Redis缓存</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-6-1-封装redis工具">4.6.1.封装Redis工具</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-6-2-实现redis查询">4.6.2.实现Redis查询</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_4-7-nginx本地缓存">4.7.Nginx本地缓存</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-7-1-本地缓存api">4.7.1.本地缓存API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-7-2-实现本地缓存查询">4.7.2.实现本地缓存查询</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-1-数据同步策略">5.1.数据同步策略</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-2-安装canal">5.2.安装Canal</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-1-认识canal">5.2.1.认识Canal</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-2-2-安装canal">5.2.2.安装Canal</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_5-3-监听canal">5.3.监听Canal</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-1-引入依赖">5.3.1.引入依赖：</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-2-编写配置">5.3.2.编写配置：</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-3-修改item实体类">5.3.3.修改Item实体类</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-3-4-编写监听器">5.3.4.编写监听器</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content" vp-content><h1 id="多级缓存" tabindex="-1"><a class="header-anchor" href="#多级缓存"><span>多级缓存</span></a></h1><h1 id="_0-学习目标" tabindex="-1"><a class="header-anchor" href="#_0-学习目标"><span>0.学习目标</span></a></h1><h1 id="_1-什么是多级缓存" tabindex="-1"><a class="header-anchor" href="#_1-什么是多级缓存"><span>1.什么是多级缓存</span></a></h1><p>传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：</p><figure><img src="/blog/assets/img/image-20210821075259137.cbd78d2a.png" alt="image-20210821075259137" tabindex="0" loading="lazy"><figcaption>image-20210821075259137</figcaption></figure><p>存在下面的问题：</p><p>•请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈</p><p>•Redis缓存失效时，会对数据库产生冲击</p><p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：</p><ul><li>浏览器访问静态资源时，优先读取浏览器本地缓存</li><li>访问非静态资源（ajax查询数据）时，访问服务端</li><li>请求到达Nginx后，优先读取Nginx本地缓存</li><li>如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）</li><li>如果Redis查询未命中，则查询Tomcat</li><li>请求进入Tomcat后，优先查询JVM进程缓存</li><li>如果JVM进程缓存未命中，则查询数据库</li></ul><figure><img src="/blog/assets/img/image-20210821075558137.bb7b1e80.png" alt="image-20210821075558137" tabindex="0" loading="lazy"><figcaption>image-20210821075558137</figcaption></figure><p>在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个<strong>反向代理服务器</strong>，而是一个编写<strong>业务的Web服务器了</strong>。</p><p>因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：</p><figure><img src="/blog/assets/img/image-20210821080511581.2b31490c.png" alt="image-20210821080511581" tabindex="0" loading="lazy"><figcaption>image-20210821080511581</figcaption></figure><p>另外，我们的Tomcat服务将来也会部署为集群模式：</p><figure><img src="/blog/assets/img/image-20210821080954947.d1ed2ce2.png" alt="image-20210821080954947" tabindex="0" loading="lazy"><figcaption>image-20210821080954947</figcaption></figure><p>可见，多级缓存的关键有两个：</p><ul><li><p>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询</p></li><li><p>另一个就是在Tomcat中实现JVM进程缓存</p></li></ul><p>其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。</p><p>这也是今天课程的难点和重点。</p><h1 id="_2-jvm进程缓存" tabindex="-1"><a class="header-anchor" href="#_2-jvm进程缓存"><span>2.JVM进程缓存</span></a></h1><p>为了演示多级缓存的案例，我们先准备一个商品查询的业务。</p><h2 id="_2-1-导入案例" tabindex="-1"><a class="header-anchor" href="#_2-1-导入案例"><span>2.1.导入案例</span></a></h2><p>参考课前资料的：《案例导入说明.md》</p><figure><img src="data:image/png;base64,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" alt="image-20210821081418456" tabindex="0" loading="lazy"><figcaption>image-20210821081418456</figcaption></figure><h2 id="_2-2-初识caffeine" tabindex="-1"><a class="header-anchor" href="#_2-2-初识caffeine"><span>2.2.初识Caffeine</span></a></h2><p>缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类：</p><ul><li>分布式缓存，例如Redis： <ul><li>优点：存储容量更大、可靠性更好、可以在集群间共享</li><li>缺点：访问缓存有网络开销</li><li>场景：缓存数据量较大、可靠性要求较高、需要在集群间共享</li></ul></li><li>进程本地缓存，例如HashMap、GuavaCache： <ul><li>优点：读取本地内存，没有网络开销，速度更快</li><li>缺点：存储容量有限、可靠性较低、无法共享</li><li>场景：性能要求较高，缓存数据量较小</li></ul></li></ul><p>我们今天会利用Caffeine框架来实现JVM进程缓存。</p><p><strong>Caffeine</strong>是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine。GitHub地址：https://github.com/ben-manes/caffeine</p><p>Caffeine的性能非常好，下图是官方给出的性能对比：</p><figure><img src="/blog/assets/img/image-20210821081826399.686049b3.png" alt="image-20210821081826399" tabindex="0" loading="lazy"><figcaption>image-20210821081826399</figcaption></figure><p>可以看到Caffeine的性能遥遥领先！</p><p>缓存使用的基本API：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Test</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> testBasicOps</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 构建cache对象</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 存数据</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;gf&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;迪丽热巴&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 取数据</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gf </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getIfPresent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;gf&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;gf = &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> gf);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 取数据，包含两个参数：</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 参数一：缓存的key</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> defaultGF </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;defaultGF&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, key </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 根据key去数据库查询数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;柳岩&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;defaultGF = &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> defaultGF);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Caffeine既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。</p><p>Caffeine提供了三种缓存驱逐策略：</p><ul><li><p><strong>基于容量</strong>：设置缓存的数量上限</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 创建缓存对象</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maximumSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // 设置缓存大小上限为 1</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>基于时间</strong>：设置缓存的有效时间</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 创建缓存对象</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cache </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 设置缓存有效期为 10 秒，从最后一次写入开始计时 </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">expireAfterWrite</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Duration</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ofSeconds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>基于引用</strong>：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。</p></li></ul><blockquote><p><strong>注意</strong>：在默认情况下，当一个缓存元素过期的时候，Caffeine不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。</p></blockquote><h2 id="_2-3-实现jvm进程缓存" tabindex="-1"><a class="header-anchor" href="#_2-3-实现jvm进程缓存"><span>2.3.实现JVM进程缓存</span></a></h2><h3 id="_2-3-1-需求" tabindex="-1"><a class="header-anchor" href="#_2-3-1-需求"><span>2.3.1.需求</span></a></h3><p>利用Caffeine实现下列需求：</p><ul><li>给根据id查询商品的业务添加缓存，缓存未命中时查询数据库</li><li>给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库</li><li>缓存初始大小为100</li><li>缓存上限为10000</li></ul><h3 id="_2-3-2-实现" tabindex="-1"><a class="header-anchor" href="#_2-3-2-实现"><span>2.3.2.实现</span></a></h3><p>首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。</p><p>在item-service的<code>com.heima.item.config</code>包下定义<code>CaffeineConfig</code>类：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> com.heima.item.config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.github.benmanes.caffeine.cache.Cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.github.benmanes.caffeine.cache.Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.ItemStock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.context.annotation.Bean</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.context.annotation.Configuration</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CaffeineConfig</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Bean</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">initialCapacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maximumSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10_000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Bean</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ItemStock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> stockCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Caffeine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">newBuilder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">initialCapacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">maximumSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10_000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，修改item-service中的<code>com.heima.item.web</code>包下的ItemController类，添加缓存逻辑：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">RestController</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">RequestMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ItemController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> IItemService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> IItemStockService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Item</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ItemStock</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ...其它略</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/{id}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Item</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> findById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">PathVariable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(id, key </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> itemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">query</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ne</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;status&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">eq</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, key)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">one</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        );</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/stock/{id}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ItemStock</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> findStockById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">PathVariable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stockCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(id, key </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_3-lua语法入门" tabindex="-1"><a class="header-anchor" href="#_3-lua语法入门"><span>3.Lua语法入门</span></a></h1><p>Nginx编程需要用到Lua语言，因此我们必须先入门Lua的基本语法。</p><h2 id="_3-1-初识lua" tabindex="-1"><a class="header-anchor" href="#_3-1-初识lua"><span>3.1.初识Lua</span></a></h2><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网：https://www.lua.org/</p><figure><img src="/blog/assets/img/image-20210821091437975.ceea1382.png" alt="image-20210821091437975" tabindex="0" loading="lazy"><figcaption>image-20210821091437975</figcaption></figure><p>Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。</p><p>Nginx本身也是C语言开发，因此也允许基于Lua做拓展。</p><h2 id="_3-1-helloworld" tabindex="-1"><a class="header-anchor" href="#_3-1-helloworld"><span>3.1.HelloWorld</span></a></h2><p>CentOS7默认已经安装了Lua语言环境，所以可以直接运行Lua代码。</p><p>1）在Linux虚拟机的任意目录下，新建一个hello.lua文件</p><figure><img src="data:image/png;base64,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" alt="image-20210821091621308" tabindex="0" loading="lazy"><figcaption>image-20210821091621308</figcaption></figure><p>2）添加下面的内容</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello World!&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>3）运行</p><figure><img src="data:image/png;base64,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" alt="image-20210821091638140" tabindex="0" loading="lazy"><figcaption>image-20210821091638140</figcaption></figure><h2 id="_3-2-变量和循环" tabindex="-1"><a class="header-anchor" href="#_3-2-变量和循环"><span>3.2.变量和循环</span></a></h2><p>学习任何语言必然离不开变量，而变量的声明必须先知道数据的类型。</p><h3 id="_3-2-1-lua的数据类型" tabindex="-1"><a class="header-anchor" href="#_3-2-1-lua的数据类型"><span>3.2.1.Lua的数据类型</span></a></h3><p>Lua中支持的常见数据类型包括：</p><figure><img src="/blog/assets/img/image-20210821091835406.255b84cf.png" alt="image-20210821091835406" tabindex="0" loading="lazy"><figcaption>image-20210821091835406</figcaption></figure><p>另外，Lua提供了type()函数来判断一个变量的数据类型：</p><figure><img src="/blog/assets/img/image-20210821091904332.99dd56ef.png" alt="image-20210821091904332" tabindex="0" loading="lazy"><figcaption>image-20210821091904332</figcaption></figure><h3 id="_3-2-2-声明变量" tabindex="-1"><a class="header-anchor" href="#_3-2-2-声明变量"><span>3.2.2.声明变量</span></a></h3><p>Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明字符串，可以用单引号或双引号，</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> str</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;hello&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 字符串拼接可以使用 ..</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> str2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;hello&#39; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;world&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明数字</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> num</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明布尔类型</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> flag</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明数组 ，key为角标的 table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;java&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;python&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;lua&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明table，类似java的map</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =  {</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Jack&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">age</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua中的数组角标是从1开始，访问的时候与Java中类似：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 访问数组，lua数组的角标从1开始</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua中的table可以用key来访问：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 访问table</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;name&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.name)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-3-循环" tabindex="-1"><a class="header-anchor" href="#_3-2-3-循环"><span>3.2.3.循环</span></a></h3><p>对于table，我们可以利用for循环来遍历。不过数组和普通table遍历略有差异。</p><p>遍历数组：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明数组 key为索引的 table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;java&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;python&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;lua&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 遍历数组</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> ipairs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>遍历普通table</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 声明map，也就是table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;Jack&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">age</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 遍历table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> pairs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">   print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-条件控制、函数" tabindex="-1"><a class="header-anchor" href="#_3-3-条件控制、函数"><span>3.3.条件控制、函数</span></a></h2><p>Lua中的条件控制和函数声明与Java类似。</p><h3 id="_3-3-1-函数" tabindex="-1"><a class="header-anchor" href="#_3-3-1-函数"><span>3.3.1.函数</span></a></h3><p>定义函数的语法：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 函数名( </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">argument1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">argument2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">..., </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">argumentn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 函数体</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 返回值</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例如，定义一个函数，用来打印数组：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> printArr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> ipairs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-2-条件控制" tabindex="-1"><a class="header-anchor" href="#_3-3-2-条件控制"><span>3.3.2.条件控制</span></a></h3><p>类似Java的条件控制，例如if、else语法：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(布尔表达式)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   --[ 布尔表达式为 true 时执行该语句块 --]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   --[ 布尔表达式为 false 时执行该语句块 --]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与java不同，布尔表达式中的逻辑运算是基于英文单词：</p><figure><img src="/blog/assets/img/image-20210821092657918.e06b5c93.png" alt="image-20210821092657918" tabindex="0" loading="lazy"><figcaption>image-20210821092657918</figcaption></figure><h3 id="_3-3-3-案例" tabindex="-1"><a class="header-anchor" href="#_3-3-3-案例"><span>3.3.3.案例</span></a></h3><p>需求：自定义一个函数，可以打印table，当参数为nil时，打印错误信息</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> printArr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;数组不能为空！&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> ipairs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">arr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_4-实现多级缓存" tabindex="-1"><a class="header-anchor" href="#_4-实现多级缓存"><span>4.实现多级缓存</span></a></h1><p>多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。</p><h2 id="_4-1-安装openresty" tabindex="-1"><a class="header-anchor" href="#_4-1-安装openresty"><span>4.1.安装OpenResty</span></a></h2><p>OpenResty® 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：</p><ul><li>具备Nginx的完整功能</li><li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li><li>允许使用Lua<strong>自定义业务逻辑</strong>、<strong>自定义库</strong></li></ul><p>官方网站： https://openresty.org/cn/</p><figure><img src="/blog/assets/img/image-20210821092902946.754b6796.png" alt="image-20210821092902946" tabindex="0" loading="lazy"><figcaption>image-20210821092902946</figcaption></figure><p>安装Lua可以参考课前资料提供的《安装OpenResty.md》：</p><figure><img src="data:image/png;base64,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" alt="image-20210821092941139" tabindex="0" loading="lazy"><figcaption>image-20210821092941139</figcaption></figure><h2 id="_4-2-openresty快速入门" tabindex="-1"><a class="header-anchor" href="#_4-2-openresty快速入门"><span>4.2.OpenResty快速入门</span></a></h2><p>我们希望达到的多级缓存架构如图：</p><figure><img src="/blog/assets/img/yeVDlwtfMx.3799f0c9.png" alt="yeVDlwtfMx" tabindex="0" loading="lazy"><figcaption>yeVDlwtfMx</figcaption></figure><p>其中：</p><ul><li><p>windows上的nginx用来做反向代理服务，将前端的查询商品的ajax请求代理到OpenResty集群</p></li><li><p>OpenResty集群用来编写多级缓存业务</p></li></ul><h3 id="_4-2-1-反向代理流程" tabindex="-1"><a class="header-anchor" href="#_4-2-1-反向代理流程"><span>4.2.1.反向代理流程</span></a></h3><p>现在，商品详情页使用的是假的商品数据。不过在浏览器中，可以看到页面有发起ajax请求查询真实商品数据。</p><p>这个请求如下：</p><figure><img src="/blog/assets/img/image-20210821093144700.4e75d2e8.png" alt="image-20210821093144700" tabindex="0" loading="lazy"><figcaption>image-20210821093144700</figcaption></figure><p>请求地址是localhost，端口是80，就被windows上安装的Nginx服务给接收到了。然后代理给了OpenResty集群：</p><figure><img src="/blog/assets/img/image-20210821094447709.70a12787.png" alt="image-20210821094447709" tabindex="0" loading="lazy"><figcaption>image-20210821094447709</figcaption></figure><p>我们需要在OpenResty中编写业务，查询商品数据并返回到浏览器。</p><p>但是这次，我们先在OpenResty接收请求，返回假的商品数据。</p><h3 id="_4-2-2-openresty监听请求" tabindex="-1"><a class="header-anchor" href="#_4-2-2-openresty监听请求"><span>4.2.2.OpenResty监听请求</span></a></h3><p>OpenResty的很多功能都依赖于其目录下的Lua库，需要在nginx.conf中指定依赖库的目录，并导入依赖：</p><p>1）添加对OpenResty的Lua模块的加载</p><p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，在其中的http下面，添加下面代码：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#lua 模块</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">lua_package_path</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;/usr/local/openresty/lualib/?.lua;;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#c模块     </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">lua_package_cpath</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;/usr/local/openresty/lualib/?.so;;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）监听/api/item路径</p><p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，在nginx.conf的server下面，添加对/api/item这个路径的监听：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  /api/item {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 默认的响应类型</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    default_type </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">application/json;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 响应结果由lua/item.lua文件来决定</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    content_by_lua_file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lua/item.lua;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个监听，就类似于SpringMVC中的<code>@GetMapping(&quot;/api/item&quot;)</code>做路径映射。</p><p>而<code>content_by_lua_file lua/item.lua</code>则相当于调用item.lua这个文件，执行其中的业务，把结果返回给用户。相当于java中调用service。</p><h3 id="_4-2-3-编写item-lua" tabindex="-1"><a class="header-anchor" href="#_4-2-3-编写item-lua"><span>4.2.3.编写item.lua</span></a></h3><p>1）在<code>/usr/loca/openresty/nginx</code>目录创建文件夹：lua</p><figure><img src="/blog/assets/img/image-20210821100755080.365d2a05.png" alt="image-20210821100755080" tabindex="0" loading="lazy"><figcaption>image-20210821100755080</figcaption></figure><p>2）在<code>/usr/loca/openresty/nginx/lua</code>文件夹下，新建文件：item.lua</p><figure><img src="/blog/assets/img/image-20210821100801756.4b876f8d.png" alt="image-20210821100801756" tabindex="0" loading="lazy"><figcaption>image-20210821100801756</figcaption></figure><p>3）编写item.lua，返回假数据</p><p>item.lua中，利用ngx.say()函数返回数据到Response中</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">say</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;{&quot;id&quot;:10001,&quot;name&quot;:&quot;SALSA AIR&quot;,&quot;title&quot;:&quot;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&quot;,&quot;price&quot;:17900,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;拉杆箱&quot;,&quot;brand&quot;:&quot;RIMOWA&quot;,&quot;spec&quot;:&quot;&quot;,&quot;status&quot;:1,&quot;createTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;updateTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;stock&quot;:2999,&quot;sold&quot;:31290}&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>4）重新加载配置</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>刷新商品页面：http://localhost/item.html?id=1001，即可看到效果：</p><figure><img src="/blog/assets/img/image-20210821101217089.8ff761ab.png" alt="image-20210821101217089" tabindex="0" loading="lazy"><figcaption>image-20210821101217089</figcaption></figure><h2 id="_4-3-请求参数处理" tabindex="-1"><a class="header-anchor" href="#_4-3-请求参数处理"><span>4.3.请求参数处理</span></a></h2><p>上一节中，我们在OpenResty接收前端请求，但是返回的是假数据。</p><p>要返回真实数据，必须根据前端传递来的商品id，查询商品信息才可以。</p><p>那么如何获取前端传递的商品参数呢？</p><h3 id="_4-3-1-获取参数的api" tabindex="-1"><a class="header-anchor" href="#_4-3-1-获取参数的api"><span>4.3.1.获取参数的API</span></a></h3><p>OpenResty中提供了一些API用来获取不同类型的前端请求参数：</p><figure><img src="/blog/assets/img/image-20210821101433528.08eee74c.png" alt="image-20210821101433528" tabindex="0" loading="lazy"><figcaption>image-20210821101433528</figcaption></figure><h3 id="_4-3-2-获取参数并返回" tabindex="-1"><a class="header-anchor" href="#_4-3-2-获取参数并返回"><span>4.3.2.获取参数并返回</span></a></h3><p>在前端发起的ajax请求如图：</p><figure><img src="/blog/assets/img/image-20210821101721649.a27d0bf0.png" alt="image-20210821101721649" tabindex="0" loading="lazy"><figcaption>image-20210821101721649</figcaption></figure><p>可以看到商品id是以路径占位符方式传递的，因此可以利用正则表达式匹配的方式来获取ID</p><p>1）获取商品id</p><p>修改<code>/usr/loca/openresty/nginx/nginx.conf</code>文件中监听/api/item的代码，利用正则表达式获取ID：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ~ </span><span style="--shiki-light:#0184BC;--shiki-dark:#E06C75;">/api/item/(\d+) </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 默认的响应类型</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    default_type </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">application/json;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 响应结果由lua/item.lua文件来决定</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    content_by_lua_file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lua/item.lua;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）拼接ID并返回</p><p>修改<code>/usr/loca/openresty/nginx/lua/item.lua</code>文件，获取id并拼接到结果中返回：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 获取商品id</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.var[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 拼接并返回</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">say</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;{&quot;id&quot;:&#39; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> .. </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;,&quot;name&quot;:&quot;SALSA AIR&quot;,&quot;title&quot;:&quot;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&quot;,&quot;price&quot;:17900,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;拉杆箱&quot;,&quot;brand&quot;:&quot;RIMOWA&quot;,&quot;spec&quot;:&quot;&quot;,&quot;status&quot;:1,&quot;createTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;updateTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;stock&quot;:2999,&quot;sold&quot;:31290}&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）重新加载并测试</p><p>运行命令以重新加载OpenResty配置：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>刷新页面可以看到结果中已经带上了ID：</p><figure><img src="/blog/assets/img/image-20210821102235467.d8b19640.png" alt="image-20210821102235467" tabindex="0" loading="lazy"><figcaption>image-20210821102235467</figcaption></figure><h2 id="_4-4-查询tomcat" tabindex="-1"><a class="header-anchor" href="#_4-4-查询tomcat"><span>4.4.查询Tomcat</span></a></h2><p>拿到商品ID后，本应去缓存中查询商品信息，不过目前我们还未建立nginx、redis缓存。因此，这里我们先根据商品id去tomcat查询商品信息。我们实现如图部分：</p><figure><img src="/blog/assets/img/image-20210821102610167.8f3be4f4.png" alt="image-20210821102610167" tabindex="0" loading="lazy"><figcaption>image-20210821102610167</figcaption></figure><p>需要注意的是，我们的OpenResty是在虚拟机，Tomcat是在Windows电脑上。两者IP一定不要搞错了。</p><figure><img src="/blog/assets/img/image-20210821102959829.dd35b405.png" alt="image-20210821102959829" tabindex="0" loading="lazy"><figcaption>image-20210821102959829</figcaption></figure><h3 id="_4-4-1-发送http请求的api" tabindex="-1"><a class="header-anchor" href="#_4-4-1-发送http请求的api"><span>4.4.1.发送http请求的API</span></a></h3><p>nginx提供了内部API用以发送http请求：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.location.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">capture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/path&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    method</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.HTTP_GET,   </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 请求方式</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">},  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- get方式传参数</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">})</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回的响应内容包括：</p><ul><li>resp.status：响应状态码</li><li>resp.header：响应头，是一个table</li><li>resp.body：响应体，就是响应数据</li></ul><p>注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。</p><p>但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> /path {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     # 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     proxy_pass </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http://192.168.150.1:8081; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>原理如图：</p><figure><img src="/blog/assets/img/image-20210821104149061.3002d8b9.png" alt="image-20210821104149061" tabindex="0" loading="lazy"><figcaption>image-20210821104149061</figcaption></figure><h3 id="_4-4-2-封装http工具" tabindex="-1"><a class="header-anchor" href="#_4-4-2-封装http工具"><span>4.4.2.封装http工具</span></a></h3><p>下面，我们封装一个发送Http请求的工具，基于ngx.location.capture来实现查询tomcat。</p><p>1）添加反向代理，到windows的Java服务</p><p>因为item-service中的接口都是/item开头，所以我们监听/item路径，代理到windows上的tomcat服务。</p><p>修改 <code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，添加一个location：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> /item {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http://192.168.150.1:8081;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以后，只要我们调用<code>ngx.location.capture(&quot;/item&quot;)</code>，就一定能发送请求到windows的tomcat服务。</p><p>2）封装工具类</p><p>之前我们说过，OpenResty启动时会加载以下两个目录中的工具文件：</p><figure><img src="/blog/assets/img/image-20210821104857413.9ce79b45.png" alt="image-20210821104857413" tabindex="0" loading="lazy"><figcaption>image-20210821104857413</figcaption></figure><p>所以，自定义的http工具也需要放到这个目录下。</p><p>在<code>/usr/local/openresty/lualib</code>目录下，新建一个common.lua文件：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vi</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/openresty/lualib/common.lua</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>内容如下:</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 封装函数，发送http请求，并解析响应</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.location.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">capture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        method</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.HTTP_GET,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    })</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">resp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 记录错误信息，返回404</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;http请求查询失败, path: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> , </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;, args: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">exit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">404</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.body</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 将方法导出</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _M</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">read_http</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _M</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个工具将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出。</p><p>使用的时候，可以利用<code>require(&#39;common&#39;)</code>来导入该函数库，这里的common是函数库的文件名。</p><p>3）实现商品查询</p><p>最后，我们修改<code>/usr/local/openresty/lua/item.lua</code>文件，利用刚刚封装的函数库实现对tomcat的查询：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 引入自定义common工具模块，返回值是common中返回的 _M</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;common&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 从 common中获取read_http这个函数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_http</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 获取路径参数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.var[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 根据id查询商品</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 根据id查询商品库存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemStockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/stock/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里查询到的结果是json字符串，并且包含商品、库存两个json字符串，页面最终需要的是把两个json拼接为一个json：</p><figure><img src="/blog/assets/img/image-20210821110441222.f1354561.png" alt="image-20210821110441222" tabindex="0" loading="lazy"><figcaption>image-20210821110441222</figcaption></figure><p>这就需要我们先把JSON变为lua的table，完成数据整合后，再转为JSON。</p><h3 id="_4-4-3-cjson工具类" tabindex="-1"><a class="header-anchor" href="#_4-4-3-cjson工具类"><span>4.4.3.CJSON工具类</span></a></h3><p>OpenResty提供了一个cjson的模块用来处理JSON的序列化和反序列化。</p><p>官方地址： https://github.com/openresty/lua-cjson/</p><p>1）引入cjson模块：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;cjson&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2）序列化：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;jack&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    age</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 把 table 序列化为 json</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">encode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）反序列化：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;{&quot;name&quot;: &quot;jack&quot;, &quot;age&quot;: 21}&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 反序列化 json为 table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">json</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.name)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-4-实现tomcat查询" tabindex="-1"><a class="header-anchor" href="#_4-4-4-实现tomcat查询"><span>4.4.4.实现Tomcat查询</span></a></h3><p>下面，我们修改之前的item.lua中的业务，添加json处理功能：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入common函数库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;common&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_http</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入cjson库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;cjson&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 获取路径参数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.var[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 根据id查询商品</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 根据id查询商品库存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemStockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/stock/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- JSON转化为lua的table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 组合数据</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.stock = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.stock</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sold = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sold</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 把item序列化为json 返回结果</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">say</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">encode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-5-基于id负载均衡" tabindex="-1"><a class="header-anchor" href="#_4-4-5-基于id负载均衡"><span>4.4.5.基于ID负载均衡</span></a></h3><p>刚才的代码中，我们的tomcat是单机部署。而实际开发中，tomcat一定是集群模式：</p><figure><img src="/blog/assets/img/image-20210821111023255.a285a54a.png" alt="image-20210821111023255" tabindex="0" loading="lazy"><figcaption>image-20210821111023255</figcaption></figure><p>因此，OpenResty需要对tomcat集群做负载均衡。</p><p>而默认的负载均衡规则是轮询模式，当我们查询/item/10001时：</p><ul><li>第一次会访问8081端口的tomcat服务，在该服务内部就形成了JVM进程缓存</li><li>第二次会访问8082端口的tomcat服务，该服务内部没有JVM缓存（因为JVM缓存无法共享），会查询数据库</li><li>...</li></ul><p>你看，因为轮询的原因，第一次查询8081形成的JVM缓存并未生效，直到下一次再次访问到8081时才可以生效，缓存命中率太低了。</p><p>怎么办？</p><p>如果能让同一个商品，每次查询时都访问同一个tomcat服务，那么JVM缓存就一定能生效了。</p><p>也就是说，我们需要根据商品id做负载均衡，而不是轮询。</p><h4 id="_1-原理" tabindex="-1"><a class="header-anchor" href="#_1-原理"><span>1）原理</span></a></h4><p>nginx提供了基于请求路径做负载均衡的算法：</p><p>nginx根据请求路径做hash运算，把得到的数值对tomcat服务的数量取余，余数是几，就访问第几个服务，实现负载均衡。</p><p>例如：</p><ul><li>我们的请求路径是 /item/10001</li><li>tomcat总数为2台（8081、8082）</li><li>对请求路径/item/1001做hash运算求余的结果为1</li><li>则访问第一个tomcat服务，也就是8081</li></ul><p>只要id不变，每次hash运算结果也不会变，那就可以保证同一个商品，一直访问同一个tomcat服务，确保JVM缓存生效。</p><h4 id="_2-实现" tabindex="-1"><a class="header-anchor" href="#_2-实现"><span>2）实现</span></a></h4><p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，实现基于ID做负载均衡。</p><p>首先，定义tomcat集群，并设置基于路径做负载均衡：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">upstream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tomcat-cluster {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    hash </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">request_uri</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 192.168.150.1:8081;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 192.168.150.1:8082;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，修改对tomcat服务的反向代理，目标指向tomcat集群：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> /item {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http://tomcat-cluster;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新加载OpenResty</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3-测试" tabindex="-1"><a class="header-anchor" href="#_3-测试"><span>3）测试</span></a></h4><p>启动两台tomcat服务：</p><figure><img src="/blog/assets/img/image-20210821112420464.f5f97438.png" alt="image-20210821112420464" tabindex="0" loading="lazy"><figcaption>image-20210821112420464</figcaption></figure><p>同时启动：</p><figure><img src="/blog/assets/img/image-20210821112444482.48ccb1d5.png" alt="image-20210821112444482" tabindex="0" loading="lazy"><figcaption>image-20210821112444482</figcaption></figure><p>清空日志后，再次访问页面，可以看到不同id的商品，访问到了不同的tomcat服务：</p><figure><img src="/blog/assets/img/image-20210821112559965.5408c13f.png" alt="image-20210821112559965" tabindex="0" loading="lazy"><figcaption>image-20210821112559965</figcaption></figure><figure><img src="/blog/assets/img/image-20210821112637430.78aa1402.png" alt="image-20210821112637430" tabindex="0" loading="lazy"><figcaption>image-20210821112637430</figcaption></figure><h2 id="_4-5-redis缓存预热" tabindex="-1"><a class="header-anchor" href="#_4-5-redis缓存预热"><span>4.5.Redis缓存预热</span></a></h2><p>Redis缓存会面临冷启动问题：</p><p><strong>冷启动</strong>：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。</p><p><strong>缓存预热</strong>：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。</p><p>我们数据量较少，并且没有数据统计相关功能，目前可以在启动时将所有数据都放入缓存中。</p><p>1）利用Docker安装Redis</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 6379:6379</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis-server</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --appendonly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2）在item-service服务中引入Redis依赖</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;spring-boot-starter-data-redis&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）配置Redis地址</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">192.168.150.101</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）编写初始化类</p><p>缓存预热需要在项目启动时完成，并且必须是拿到RedisTemplate之后。</p><p>这里我们利用InitializingBean接口来实现，因为InitializingBean可以在对象被Spring创建并且成员变量全部注入后执行。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> com.heima.item.config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.fasterxml.jackson.core.JsonProcessingException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.fasterxml.jackson.databind.ObjectMapper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.ItemStock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.service.IItemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.service.IItemStockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.beans.factory.InitializingBean</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.beans.factory.annotation.Autowired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.data.redis.core.StringRedisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.stereotype.Component</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> java.util.List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> InitializingBean</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> StringRedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> IItemService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> IItemStockService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ObjectMapper</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> MAPPER </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ObjectMapper</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> afterPropertiesSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 初始化缓存</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 1.查询商品信息</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">itemList</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> itemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 2.放入缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> itemList) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.1.item序列化为JSON</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> MAPPER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeValueAsString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(item);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.2.存入redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:id:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), json);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 3.查询商品库存信息</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ItemStock</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stockList</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 4.放入缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ItemStock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> stockList) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.1.item序列化为JSON</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> MAPPER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeValueAsString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stock);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.2.存入redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:stock:id:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), json);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-6-查询redis缓存" tabindex="-1"><a class="header-anchor" href="#_4-6-查询redis缓存"><span>4.6.查询Redis缓存</span></a></h2><p>现在，Redis缓存已经准备就绪，我们可以再OpenResty中实现查询Redis的逻辑了。如下图红框所示：</p><figure><img src="/blog/assets/img/image-20210821113340111.bd0dcc70.png" alt="image-20210821113340111" tabindex="0" loading="lazy"><figcaption>image-20210821113340111</figcaption></figure><p>当请求进入OpenResty之后：</p><ul><li>优先查询Redis缓存</li><li>如果Redis缓存未命中，再查询Tomcat</li></ul><h3 id="_4-6-1-封装redis工具" tabindex="-1"><a class="header-anchor" href="#_4-6-1-封装redis工具"><span>4.6.1.封装Redis工具</span></a></h3><p>OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用。但是为了方便，我们将Redis操作封装到之前的common.lua工具库中。</p><p>修改<code>/usr/local/openresty/lualib/common.lua</code>文件：</p><p>1）引入Redis模块，并初始化Redis对象</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入redis</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;resty.redis&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 初始化redis</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set_timeouts</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）封装函数，用来释放Redis连接，其实是放入连接池</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 关闭redis连接的工具方法，其实是放入连接池</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> close_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pool_max_idle_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> -- 连接的空闲时间，单位是毫秒</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pool_size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> --连接池大小</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set_keepalive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pool_max_idle_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pool_size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;放入redis连接池失败: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）封装函数，根据key查询Redis数据</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 获取一个连接</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;连接redis失败 : &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询redis</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询失败处理</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">resp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询Redis失败: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;, key = &quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    --得到的数据为空处理</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> == </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.null </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询Redis数据为空, key = &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    close_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）导出</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 将方法导出</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _M</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">read_redis</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _M</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完整的common.lua：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入redis</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;resty.redis&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 初始化redis</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set_timeouts</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 关闭redis连接的工具方法，其实是放入连接池</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> close_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pool_max_idle_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> -- 连接的空闲时间，单位是毫秒</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pool_size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> --连接池大小</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set_keepalive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pool_max_idle_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">pool_size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;放入redis连接池失败: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 获取一个连接</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">connect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ok</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;连接redis失败 : &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询redis</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询失败处理</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">resp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询Redis失败: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;, key = &quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    --得到的数据为空处理</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> == </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.null </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询Redis数据为空, key = &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    close_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">red</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 封装函数，发送http请求，并解析响应</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.location.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">capture</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        method</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.HTTP_GET,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    })</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">resp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 记录错误信息，返回404</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;http查询失败, path: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> , </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;, args: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">exit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">404</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> resp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.body</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 将方法导出</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _M</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {  </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">read_redis</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}  </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _M</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-2-实现redis查询" tabindex="-1"><a class="header-anchor" href="#_4-6-2-实现redis查询"><span>4.6.2.实现Redis查询</span></a></h3><p>接下来，我们就可以去修改item.lua文件，实现对Redis的查询了。</p><p>查询逻辑是：</p><ul><li>根据id查询Redis</li><li>如果查询失败则继续查询Tomcat</li><li>将查询结果返回</li></ul><p>1）修改<code>/usr/local/openresty/lua/item.lua</code>文件，添加一个查询函数：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入common函数库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;common&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_http</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_redis</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 封装查询函数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询本地缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 判断查询结果</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;redis查询失败，尝试查询http， key: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- redis查询失败，去查询http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 返回数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）而后修改商品查询、库存查询的业务：</p><figure><img src="/blog/assets/img/image-20210821114528954.1d349634.png" alt="image-20210821114528954" tabindex="0" loading="lazy"><figcaption>image-20210821114528954</figcaption></figure><p>3）完整的item.lua代码：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入common函数库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;common&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_http</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_redis</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入cjson库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;cjson&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 封装查询函数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询本地缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 判断查询结果</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;redis查询失败，尝试查询http， key: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- redis查询失败，去查询http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 返回数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 获取路径参数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.var[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询商品信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:id:&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询库存信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:stock:id:&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/stock/&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- JSON转化为lua的table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 组合数据</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.stock = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.stock</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sold = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sold</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 把item序列化为json 返回结果</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">say</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">encode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-7-nginx本地缓存" tabindex="-1"><a class="header-anchor" href="#_4-7-nginx本地缓存"><span>4.7.Nginx本地缓存</span></a></h2><p>现在，整个多级缓存中只差最后一环，也就是nginx的本地缓存了。如图：</p><figure><img src="/blog/assets/img/image-20210821114742950.50adabf0.png" alt="image-20210821114742950" tabindex="0" loading="lazy"><figcaption>image-20210821114742950</figcaption></figure><h3 id="_4-7-1-本地缓存api" tabindex="-1"><a class="header-anchor" href="#_4-7-1-本地缓存api"><span>4.7.1.本地缓存API</span></a></h3><p>OpenResty为Nginx提供了<strong>shard dict</strong>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。</p><p>1）开启共享字典，在nginx.conf的http下添加配置：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" data-title="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> lua_shared_dict</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item_cache </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">150m</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>2）操作共享字典：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 获取本地缓存对象</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.shared.item_cache</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;key&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;value&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 读取</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;key&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-2-实现本地缓存查询" tabindex="-1"><a class="header-anchor" href="#_4-7-2-实现本地缓存查询"><span>4.7.2.实现本地缓存查询</span></a></h3><p>1）修改<code>/usr/local/openresty/lua/item.lua</code>文件，修改read_data查询函数，添加本地缓存逻辑：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入共享词典，本地缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.shared.item_cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 封装查询函数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">expire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询本地缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;本地缓存查询失败，尝试查询Redis， key: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 查询redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 判断查询结果</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;redis查询失败，尝试查询http， key: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            -- redis查询失败，去查询http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询成功，把数据写入本地缓存</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">expire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 返回数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）修改item.lua中查询商品和库存的业务，实现最新的read_data函数：</p><figure><img src="/blog/assets/img/image-20210821115108528.ae394c6c.png" alt="image-20210821115108528" tabindex="0" loading="lazy"><figcaption>image-20210821115108528</figcaption></figure><p>其实就是多了缓存时间参数，过期后nginx缓存会自动删除，下次访问即可更新缓存。</p><p>这里给商品基本信息设置超时时间为30分钟，库存为1分钟。</p><p>因为库存更新频率较高，如果缓存时间过长，可能与数据库差异较大。</p><p>3）完整的item.lua文件：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入common函数库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;common&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_http</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">common</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.read_redis</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入cjson库</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">require</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;cjson&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 导入共享词典，本地缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.shared.item_cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 封装查询函数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">expire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#ABB2BF;--shiki-dark-font-style:italic;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询本地缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;本地缓存查询失败，尝试查询Redis， key: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 查询redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6379</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        -- 判断查询结果</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> not </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.ERR, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;redis查询失败，尝试查询http， key: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            -- redis查询失败，去查询http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">params</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        end</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 查询成功，把数据写入本地缓存</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    item_cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">expire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    -- 返回数据</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> val</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 获取路径参数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.var[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询商品信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:id:&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1800</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 查询库存信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:stock:id:&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">60</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/item/stock/&quot; </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.. </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- JSON转化为lua的table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">itemJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">decode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stockJSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 组合数据</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.stock = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.stock</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sold = </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sold</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 把item序列化为json 返回结果</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">say</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cjson</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">encode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_5-缓存同步" tabindex="-1"><a class="header-anchor" href="#_5-缓存同步"><span>5.缓存同步</span></a></h1><p>大多数情况下，浏览器查询到的都是缓存数据，如果缓存数据与数据库数据存在较大差异，可能会产生比较严重的后果。</p><p>所以我们必须保证数据库数据、缓存数据的一致性，这就是缓存与数据库的同步。</p><h2 id="_5-1-数据同步策略" tabindex="-1"><a class="header-anchor" href="#_5-1-数据同步策略"><span>5.1.数据同步策略</span></a></h2><p>缓存数据同步的常见方式有三种：</p><p><strong>设置有效期</strong>：给缓存设置有效期，到期后自动删除。再次查询时更新</p><ul><li>优势：简单、方便</li><li>缺点：时效性差，缓存过期之前可能不一致</li><li>场景：更新频率较低，时效性要求低的业务</li></ul><p><strong>同步双写</strong>：在修改数据库的同时，直接修改缓存</p><ul><li>优势：时效性强，缓存与数据库强一致</li><li>缺点：有代码侵入，耦合度高；</li><li>场景：对一致性、时效性要求较高的缓存数据</li></ul><p>**异步通知：**修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据</p><ul><li>优势：低耦合，可以同时通知多个缓存服务</li><li>缺点：时效性一般，可能存在中间不一致状态</li><li>场景：时效性要求一般，有多个服务需要同步</li></ul><p>而异步实现又可以基于MQ或者Canal来实现：</p><p>1）基于MQ的异步通知：</p><figure><img src="/blog/assets/img/image-20210821115552327.e38929cc.png" alt="image-20210821115552327" tabindex="0" loading="lazy"><figcaption>image-20210821115552327</figcaption></figure><p>解读：</p><ul><li>商品服务完成对数据的修改后，只需要发送一条消息到MQ中。</li><li>缓存服务监听MQ消息，然后完成对缓存的更新</li></ul><p>依然有少量的代码侵入。</p><p>2）基于Canal的通知</p><figure><img src="/blog/assets/img/image-20210821115719363.77324fc7.png" alt="image-20210821115719363" tabindex="0" loading="lazy"><figcaption>image-20210821115719363</figcaption></figure><p>解读：</p><ul><li>商品服务完成商品修改后，业务直接结束，没有任何代码侵入</li><li>Canal监听MySQL变化，当发现变化后，立即通知缓存服务</li><li>缓存服务接收到canal通知，更新缓存</li></ul><p>代码零侵入</p><h2 id="_5-2-安装canal" tabindex="-1"><a class="header-anchor" href="#_5-2-安装canal"><span>5.2.安装Canal</span></a></h2><h3 id="_5-2-1-认识canal" tabindex="-1"><a class="header-anchor" href="#_5-2-1-认识canal"><span>5.2.1.认识Canal</span></a></h3><p><strong>Canal [kə&#39;næl]</strong>，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费。GitHub的地址：https://github.com/alibaba/canal</p><p>Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：</p><figure><img src="/blog/assets/img/image-20210821115914748.d6f8c5ec.png" alt="image-20210821115914748" tabindex="0" loading="lazy"><figcaption>image-20210821115914748</figcaption></figure><ul><li>1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events</li><li>2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)</li><li>3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li></ul><p>而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。</p><figure><img src="/blog/assets/img/image-20210821115948395.9ea0dfb6.png" alt="image-20210821115948395" tabindex="0" loading="lazy"><figcaption>image-20210821115948395</figcaption></figure><h3 id="_5-2-2-安装canal" tabindex="-1"><a class="header-anchor" href="#_5-2-2-安装canal"><span>5.2.2.安装Canal</span></a></h3><p>安装和配置Canal参考课前资料文档：</p><figure><img src="data:image/png;base64,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" alt="image-20210821120017324" tabindex="0" loading="lazy"><figcaption>image-20210821120017324</figcaption></figure><h2 id="_5-3-监听canal" tabindex="-1"><a class="header-anchor" href="#_5-3-监听canal"><span>5.3.监听Canal</span></a></h2><p>Canal提供了各种语言的客户端，当Canal监听到binlog变化时，会通知Canal的客户端。</p><figure><img src="/blog/assets/img/image-20210821120049024.925282c2.png" alt="image-20210821120049024" tabindex="0" loading="lazy"><figcaption>image-20210821120049024</figcaption></figure><p>我们可以利用Canal提供的Java客户端，监听Canal通知消息。当收到变化的消息时，完成对缓存的更新。</p><p>不过这里我们会使用GitHub上的第三方开源的canal-starter客户端。地址：https://github.com/NormanGyllenhaal/canal-client</p><p>与SpringBoot完美整合，自动装配，比官方客户端要简单好用很多。</p><h3 id="_5-3-1-引入依赖" tabindex="-1"><a class="header-anchor" href="#_5-3-1-引入依赖"><span>5.3.1.引入依赖：</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;top.javatool&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;canal-spring-boot-starter&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">version</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;1.2.1-RELEASE&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">version</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-2-编写配置" tabindex="-1"><a class="header-anchor" href="#_5-3-2-编写配置"><span>5.3.2.编写配置：</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">canal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  destination</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">heima</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # canal的集群名字，要与安装canal时设置的名称一致</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">192.168.150.101:11111</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # canal服务地址</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-3-修改item实体类" tabindex="-1"><a class="header-anchor" href="#_5-3-3-修改item实体类"><span>5.3.3.修改Item实体类</span></a></h3><p>通过@Id、@Column、等注解完成Item与数据库表字段的映射：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> com.heima.item.pojo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.baomidou.mybatisplus.annotation.IdType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.baomidou.mybatisplus.annotation.TableField</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.baomidou.mybatisplus.annotation.TableId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.baomidou.mybatisplus.annotation.TableName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> lombok.Data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.data.annotation.Id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.data.annotation.Transient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> javax.persistence.Column</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> java.util.Date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Data</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">TableName</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;tb_item&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">TableId</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">type</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> IdType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">AUTO</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Id</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//商品id</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Column</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//商品名称</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> title</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//商品标题</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> price</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//价格（分）</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//商品图片</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> category</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//分类名称</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> brand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//品牌名称</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//规格</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//商品状态 1-正常，2-下架</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Date</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> createTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//创建时间</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Date</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> updateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//更新时间</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">TableField</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">exist</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Transient</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">TableField</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">exist</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Transient</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Integer</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sold</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-4-编写监听器" tabindex="-1"><a class="header-anchor" href="#_5-3-4-编写监听器"><span>5.3.4.编写监听器</span></a></h3><p>通过实现<code>EntryHandler&lt;T&gt;</code>接口编写监听器，监听Canal消息。注意两点：</p><ul><li>实现类通过<code>@CanalTable(&quot;tb_item&quot;)</code>指定监听的表信息</li><li>EntryHandler的泛型是与表对应的实体类</li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> com.heima.item.canal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.github.benmanes.caffeine.cache.Cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.config.RedisHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.beans.factory.annotation.Autowired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.stereotype.Component</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> top.javatool.canal.client.annotation.CanalTable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> top.javatool.canal.client.handler.EntryHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">CanalTable</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;tb_item&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ItemHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> EntryHandler</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisHandler</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Cache</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Item</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> insert</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 写数据到JVM进程缓存</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), item);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 写数据到redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">saveItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(item);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> before</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> after</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 写数据到JVM进程缓存</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">after</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), after);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 写数据到redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">saveItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(after);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 删除数据到JVM进程缓存</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        itemCache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">invalidate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 删除数据到redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">deleteItemById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里对Redis的操作都封装到了RedisHandler这个对象中，是我们之前做缓存预热时编写的一个类，内容如下：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> com.heima.item.config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.fasterxml.jackson.core.JsonProcessingException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.fasterxml.jackson.databind.ObjectMapper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.pojo.ItemStock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.service.IItemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.heima.item.service.IItemStockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.beans.factory.InitializingBean</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.beans.factory.annotation.Autowired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.data.redis.core.StringRedisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.stereotype.Component</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> java.util.List</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RedisHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> InitializingBean</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> StringRedisTemplate</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> IItemService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> IItemStockService</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ObjectMapper</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> MAPPER </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ObjectMapper</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> afterPropertiesSet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 初始化缓存</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 1.查询商品信息</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">itemList</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> itemService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 2.放入缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> itemList) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.1.item序列化为JSON</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> MAPPER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeValueAsString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(item);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.2.存入redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:id:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), json);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 3.查询商品库存信息</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        List</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ItemStock</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">stockList</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stockService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">list</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 4.放入缓存</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ItemStock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stock</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> :</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> stockList) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.1.item序列化为JSON</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> MAPPER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeValueAsString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stock);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // 2.2.存入redis</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:stock:id:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> stock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), json);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> saveItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> json</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> MAPPER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeValueAsString</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(item);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">opsForValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:id:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), json);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">JsonProcessingException</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(e);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> deleteItemById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        redisTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">delete</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item:id:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> id);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/JL-20191210/blog/edit/main/src/Database/Redis/3.高级/02-多级缓存/多级缓存.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">哟吼~</div><div class="vp-copyright">Copyright © 2025 来杯冰柠檬 </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script src="/blog/assets/js/runtime~app.f8e82470.js" defer></script><script src="/blog/assets/js/9703.e09ff620.js" defer></script><script src="/blog/assets/js/app.46b02cbe.js" defer></script>
  </body>
</html>
