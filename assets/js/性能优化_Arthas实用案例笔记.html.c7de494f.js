"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[87413],{66262:(s,i)=>{i.A=(s,i)=>{const a=s.__vccOpts||s;for(const[s,e]of i)a[s]=e;return a}},11197:(s,i,a)=>{a.r(i),a.d(i,{comp:()=>l,data:()=>n});var e=a(20641);const t={},l=(0,a(66262).A)(t,[["render",function(s,i){return(0,e.uX)(),(0,e.CE)("div",null,i[0]||(i[0]=[(0,e.Fv)('<h1 id="arthas实用案例笔记" tabindex="-1"><a class="header-anchor" href="#arthas实用案例笔记"><span>Arthas实用案例笔记</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>在实际的 Java 开发和运维中，线上问题往往出乎意料： CPU 突然飙高、内存暴涨、接口响应异常…… 此时，我们既不能轻易重启服务，又不能随意加日志，这就需要一个<strong>无侵入、动态诊断、适合生产环境</strong>的工具。</p><p><strong>Arthas</strong> 由阿里巴巴开源，是一款强大的 Java 诊断工具，可以实时连接正在运行的 JVM，帮助我们快速定位问题。 本文总结了几个常见且实用的使用案例，方便生产遇到问题时快速定位。</p><div class="language-mermaid line-numbers-mode" data-highlighter="shiki" data-ext="mermaid" data-title="mermaid" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">flowchart TD</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    A[线上问题] --&gt; B[选择目标进程]</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    B --&gt; C{诊断场景}</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    C --&gt; D1[高 CPU -&gt; thread]</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    C --&gt; D2[数据异常 -&gt; watch]</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    C --&gt; D3[配置错误 -&gt; ognl]</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    C --&gt; D4[版本不确定 -&gt; jad]</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    C --&gt; D5[内存异常 -&gt; heapdump]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="场景一-排查-cpu-飙高" tabindex="-1"><a class="header-anchor" href="#场景一-排查-cpu-飙高"><span>场景一：排查 CPU 飙高</span></a></h2><p>当线上服务的 CPU 使用率飙升，我们需要定位具体的线程和方法。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">thread</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # 查看所有线程 CPU 占用</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">threadI</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">d&gt; </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看单个线程详情及堆栈</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>找到 CPU 占用最高的线程 ID。</li><li>查看堆栈，直接定位业务代码位置，比如死循环或频繁运算。</li></ul><hr><h2 id="场景二-动态查看方法入参和返回值" tabindex="-1"><a class="header-anchor" href="#场景二-动态查看方法入参和返回值"><span>场景二：动态查看方法入参和返回值</span></a></h2><p>无需改代码，无需重启，实时观察某个方法的调用情况。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">watch</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> com.example.service.UserService</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> getUserById</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;{params, returnObj}&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>支持条件过滤：</p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">watch</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> com.example.service.UserService</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> getUserById</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;{params, returnObj}&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;params[0] == 123&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>精确观察特定 userId 的参数和返回结果。</li><li>适合排查数据异常、接口逻辑问题。</li></ul><hr><h2 id="场景三-临时修改线上静态变量" tabindex="-1"><a class="header-anchor" href="#场景三-临时修改线上静态变量"><span>场景三：临时修改线上静态变量</span></a></h2><p>配置错误但不能重启服务时，可以直接修改内存中的静态变量。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ognl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;@com.example.Config@TIMEOUT&#39;</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ognl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;@com.example.Config@TIMEOUT=5000&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>即时生效，解决某些紧急问题。</li><li>注意修改需要谨慎，确保来源可信。</li></ul><hr><h2 id="场景四-排查类加载器与依赖冲突" tabindex="-1"><a class="header-anchor" href="#场景四-排查类加载器与依赖冲突"><span>场景四：排查类加载器与依赖冲突</span></a></h2><p>jar 多版本冲突或类找不到，可以用 Arthas 查看加载信息。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> com.example.MyClass</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">classloader</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>找出类是由哪个 ClassLoader 加载的。</li><li>分析是否加载了错误版本的 jar。</li></ul><hr><h2 id="场景五-jad-反编译确认线上代码版本" tabindex="-1"><a class="header-anchor" href="#场景五-jad-反编译确认线上代码版本"><span>场景五：JAD 反编译确认线上代码版本</span></a></h2><p>不确定线上部署的 jar 是不是预期版本，可以直接反编译。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">jad</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> com.example.service.UserService</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>查看方法实现，确认是否是最新版本。</li><li>常用于线上代码核对。</li></ul><hr><h2 id="场景六-调用链分析" tabindex="-1"><a class="header-anchor" href="#场景六-调用链分析"><span>场景六：调用链分析</span></a></h2><p>定位某个方法是从哪条业务链调用的，以及耗时情况。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stack</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> com.example.service.UserService</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> getUserById</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>打印完整调用栈。</li><li>分析源头和调用路径。</li></ul><hr><h2 id="场景七-内存占用分析" tabindex="-1"><a class="header-anchor" href="#场景七-内存占用分析"><span>场景七：内存占用分析</span></a></h2><p>排查 OOM 或内存异常，需要 dump 现场。</p><p><strong>命令：</strong></p><p>bash</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">heapdump</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /tmp/heap.hprof</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>效果</strong>：</p><ul><li>导出 heap 文件，用 MAT/VisualVM 分析对象占用。</li><li>找出内存泄漏或大对象来源。</li></ul><hr><h2 id="总结-arthas-快速诊断秘籍" tabindex="-1"><a class="header-anchor" href="#总结-arthas-快速诊断秘籍"><span>总结：Arthas 快速诊断秘籍</span></a></h2><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">命令</th><th style="text-align:left;">目的</th></tr></thead><tbody><tr><td style="text-align:left;">CPU 飙高</td><td style="text-align:left;"><code>thread</code>, <code>thread &lt;id&gt;</code></td><td style="text-align:left;">找高占用线程和堆栈</td></tr><tr><td style="text-align:left;">查看方法参数</td><td style="text-align:left;"><code>watch</code></td><td style="text-align:left;">动态追踪调用数据</td></tr><tr><td style="text-align:left;">改静态变量</td><td style="text-align:left;"><code>ognl</code></td><td style="text-align:left;">修改配置立即生效</td></tr><tr><td style="text-align:left;">类加载分析</td><td style="text-align:left;"><code>sc</code>, <code>classloader</code></td><td style="text-align:left;">解决依赖冲突</td></tr><tr><td style="text-align:left;">源码反编译</td><td style="text-align:left;"><code>jad</code></td><td style="text-align:left;">确认代码版本</td></tr><tr><td style="text-align:left;">链路分析</td><td style="text-align:left;"><code>stack</code></td><td style="text-align:left;">查看调用路径和耗时</td></tr><tr><td style="text-align:left;">内存分析</td><td style="text-align:left;"><code>heapdump</code></td><td style="text-align:left;">分析内存占用及泄漏</td></tr></tbody></table>',66)]))}]]),n=JSON.parse('{"path":"/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Arthas%E5%AE%9E%E7%94%A8%E6%A1%88%E4%BE%8B%E7%AC%94%E8%AE%B0.html","title":"Arthas实用案例笔记","lang":"zh-CN","frontmatter":{"gitInclude":[]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"场景一：排查 CPU 飙高","slug":"场景一-排查-cpu-飙高","link":"#场景一-排查-cpu-飙高","children":[]},{"level":2,"title":"场景二：动态查看方法入参和返回值","slug":"场景二-动态查看方法入参和返回值","link":"#场景二-动态查看方法入参和返回值","children":[]},{"level":2,"title":"场景三：临时修改线上静态变量","slug":"场景三-临时修改线上静态变量","link":"#场景三-临时修改线上静态变量","children":[]},{"level":2,"title":"场景四：排查类加载器与依赖冲突","slug":"场景四-排查类加载器与依赖冲突","link":"#场景四-排查类加载器与依赖冲突","children":[]},{"level":2,"title":"场景五：JAD 反编译确认线上代码版本","slug":"场景五-jad-反编译确认线上代码版本","link":"#场景五-jad-反编译确认线上代码版本","children":[]},{"level":2,"title":"场景六：调用链分析","slug":"场景六-调用链分析","link":"#场景六-调用链分析","children":[]},{"level":2,"title":"场景七：内存占用分析","slug":"场景七-内存占用分析","link":"#场景七-内存占用分析","children":[]},{"level":2,"title":"总结：Arthas 快速诊断秘籍","slug":"总结-arthas-快速诊断秘籍","link":"#总结-arthas-快速诊断秘籍","children":[]}],"readingTime":{"minutes":2.81,"words":842},"filePathRelative":"性能优化/Arthas实用案例笔记.md","excerpt":"\\n<h2>前言</h2>\\n<p>在实际的 Java 开发和运维中，线上问题往往出乎意料：\\nCPU 突然飙高、内存暴涨、接口响应异常……\\n此时，我们既不能轻易重启服务，又不能随意加日志，这就需要一个<strong>无侵入、动态诊断、适合生产环境</strong>的工具。</p>\\n<p><strong>Arthas</strong> 由阿里巴巴开源，是一款强大的 Java 诊断工具，可以实时连接正在运行的 JVM，帮助我们快速定位问题。\\n本文总结了几个常见且实用的使用案例，方便生产遇到问题时快速定位。</p>\\n<div class=\\"language-mermaid line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"mermaid\\" data-title=\\"mermaid\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">flowchart TD</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    A[线上问题] --&gt; B[选择目标进程]</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    B --&gt; C{诊断场景}</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    C --&gt; D1[高 CPU -&gt; thread]</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    C --&gt; D2[数据异常 -&gt; watch]</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    C --&gt; D3[配置错误 -&gt; ognl]</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    C --&gt; D4[版本不确定 -&gt; jad]</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    C --&gt; D5[内存异常 -&gt; heapdump]</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}')}}]);