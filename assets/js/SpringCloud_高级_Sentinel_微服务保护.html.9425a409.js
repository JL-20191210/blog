"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[5839],{66262:(i,s)=>{s.A=(i,s)=>{const a=i.__vccOpts||i;for(const[i,n]of s)a[i]=n;return a}},24329:(i,s,a)=>{a.r(s),a.d(s,{comp:()=>$i,data:()=>is});var n=a(20641);const e=a.p+"assets/img/1533829099748.634f35a3.png",l=a.p+"assets/img/1533829198240.59a954a3.png",t=a.p+"assets/img/1533829307389.70a5d032.png",p=a.p+"assets/img/image-20210715172710340.20cbd0ca.png",h=a.p+"assets/img/image-20210715172820438.01acc961.png",r=a.p+"assets/img/image-20210715172946352.10f58fa7.png",g=a.p+"assets/img/image-20210715173215243.e674f742.png",d=a.p+"assets/img/image-20210715173327075.cd0cbf82.png",k=a.p+"assets/img/image-20210715173428073.a245c74b.png",A=a.p+"assets/img/image-20210715173555158.cd1f02b9.png",c=a.p+"assets/img/image-20210715174252531.08e439e5.png",o=a.p+"assets/img/image-20210715190827846.2791406d.png",m=a.p+"assets/img/image-20210715191134448.b72c2511.png",y=a.p+"assets/img/image-20210715191241799.6dbb3ae2.png",u=a.p+"assets/img/image-20210715191757319.4a7d877d.png",B=a.p+"assets/img/image-20210715192010657.676195e3.png",f=a.p+"assets/img/image-20210715192455429.903a225b.png",b=a.p+"assets/img/image-20210715200431615.c43467fe.png",v=a.p+"assets/img/image-20210715200537171.586adc27.png",C=a.p+"assets/img/image-20210715200635414.8dd6a7ad.png",F=a.p+"assets/img/image-20210715200804594.13414ddc.png",E=a.p+"assets/img/image-20210715200853671.1d8e35c7.png",D=a.p+"assets/img/image-20210715201827886.ec461e12.png",x=a.p+"assets/img/image-20210715202540786.c9176e83.png",Q=a.p+"assets/img/image-20210716101805951.3b498171.png",w=a.p+"assets/img/image-20210716101934499.5f7a66aa.png",P=a.p+"assets/img/image-20210716102103814.d4972b7e.png",z=a.p+"assets/img/image-20210716102416266.153fd3fd.png",_=a.p+"assets/img/image-20210716102532554.66ac22e5.png",S=a.p+"assets/img/image-20210716102636030.aef977bd.png",I=a.p+"assets/img/image-20210716103143002.811453fc.png",H=a.p+"assets/img/image-20210716103536346.e1a9e250.png",M=a.p+"assets/img/image-20210716105227163.ea8fe30c.png",j=a.p+"assets/img/image-20210716105408723.21136fcd.png",q=a.p+"assets/img/image-20210716105612312.f8373aa6.png",J=a.p+"assets/img/image-20210716105812789.1d1c2a04.png",O=a.p+"assets/img/image-20210716110027064.03f6b7ea.png",T=a.p+"assets/img/image-20210716105855951.def7e2b3.png",R=a.p+"assets/img/image-20210716105956401.f24d08c8.png",Y=a.p+"assets/img/image-20210716110225104.d1ddc523.png",L=a.p+"assets/img/image-20210716110629796.04c04ddc.png",G=a.p+"assets/img/image-20210716111012387.b1e5819d.png",U=a.p+"assets/img/image-20210716111136699.064607c5.png",Z=a.p+"assets/img/image-20210716111303701.60c374ed.png",N=a.p+"assets/img/image-20210716111404717.0853e380.png",K=a.p+"assets/img/image-20210716111526480.c4685e08.png",X=a.p+"assets/img/image-20210716111658541.6c129ae4.png",V=a.p+"assets/img/image-20210716114048918.a080d15f.png",W=a.p+"assets/img/image-20210716114243558.c3672d74.png",$=a.p+"assets/img/image-20210716114429361.b789070c.png",ii=a.p+"assets/img/image-20210716114522935.055197bf.png",si=a.p+"assets/img/image-20210716114651137.f390c8c2.png",ai=a.p+"assets/img/image-20210716115014663.1d5d1ef0.png",ni=a.p+"assets/img/image-20210716115131463.ac59bd72.png",ei=a.p+"assets/img/image-20210716115232426.19e59c6c.png",li=a.p+"assets/img/image-20210716115717523.1fb16076.png",ti=a.p+"assets/img/image-20210716120033572.1832e426.png",pi=a.p+"assets/img/image-20210716120208509.9e1efe28.png",hi=a.p+"assets/img/image-20210716120319009.7cff33df.png",ri=a.p+"assets/img/image-20210716120536714.52885390.png",gi=a.p+"assets/img/image-20210716120754527.7ee3aa80.png",di=a.p+"assets/img/image-20210716120840501.f4e19135.png",ki=a.p+"assets/img/image-20210716121105567.f7cb579d.png",Ai=a.p+"assets/img/image-20210716120900365.093f7b3c.png",ci=a.p+"assets/img/image-20210716121201630.09716d28.png",oi=a.p+"assets/img/image-20210716120919131.14b62ea9.png",mi=a.p+"assets/img/image-20210716121220305.a72bfcf6.png",yi=a.p+"assets/img/image-20210716122403502.21694561.png",ui=a.p+"assets/img/image-20210716123705780.2f22d2e3.png",Bi=a.p+"assets/img/image-20210716123036937.3ffe5ab5.png",fi=a.p+"assets/img/image-20210716123240518.86082f56.png",bi=a.p+"assets/img/image-20210716123411217.45c6298e.png",vi=a.p+"assets/img/image-20210716123831992.f935802c.png",Ci=a.p+"assets/img/image-20210716123936844.b19fe13b.png",Fi=a.p+"assets/img/image-20210716124229894.394937bb.png",Ei=a.p+"assets/img/image-20210716124147820.04334365.png",Di=a.p+"assets/img/image-20210716130958518.49c62bc5.png",xi=a.p+"assets/img/image-20210716145934347.7fe9816f.png",Qi=a.p+"assets/img/image-20210716150234787.0e2327bc.png",wi=a.p+"assets/img/image-20210716150510956.59ac2813.png",Pi=a.p+"assets/img/image-20210716150605208.bc994962.png",zi=a.p+"assets/img/image-20210716150654094.8ef97624.png",_i=a.p+"assets/img/image-20210716150740434.9a30ff9d.png",Si=a.p+"assets/img/image-20210716150911004.3b1e0e7b.png",Ii=a.p+"assets/img/image-20210716151107785.5bca44c1.png",Hi=a.p+"assets/img/image-20210716131430682.ee256d62.png",Mi=a.p+"assets/img/image-20210716131522912.4c0897d5.png",ji=a.p+"assets/img/image-20210716151348183.ceac2aee.png",qi=a.p+"assets/img/image-20210716151538785.a61aa1a5.png",Ji=a.p+"assets/img/image-20210716151722916.cd04315b.png",Oi=a.p+"assets/img/image-20210716151844817.38ebaed0.png",Ti=a.p+"assets/img/image-20210716152010750.6545af7d.png",Ri=a.p+"assets/img/image-20210716152349191.565b820b.png",Yi=a.p+"assets/img/image-20210716153250134.be22ec13.png",Li=a.p+"assets/img/image-20210716153301069.758387ce.png",Gi=a.p+"assets/img/image-20210716153348396.a726af98.png",Ui=a.p+"assets/img/image-20210716153434095.acc91d4c.png",Zi=a.p+"assets/img/image-20210716153938887.449d1a51.png",Ni=a.p+"assets/img/image-20210716154012736.6bb03a5a.png",Ki=a.p+"assets/img/image-20210716154155238.e3ef7110.png",Xi=a.p+"assets/img/image-20210716154215456.5d0e61a0.png",Vi=a.p+"assets/img/image-20210716154255466.65a27069.png",Wi={},$i=(0,a(66262).A)(Wi,[["render",function(i,s){return(0,n.uX)(),(0,n.CE)("div",null,[s[0]||(s[0]=(0,n.Fv)('<h1 id="微服务保护" tabindex="-1"><a class="header-anchor" href="#微服务保护"><span>微服务保护</span></a></h1><h1 id="_1-初识sentinel" tabindex="-1"><a class="header-anchor" href="#_1-初识sentinel"><span>1.初识Sentinel</span></a></h1><h2 id="_1-1-雪崩问题及解决方案" tabindex="-1"><a class="header-anchor" href="#_1-1-雪崩问题及解决方案"><span>1.1.雪崩问题及解决方案</span></a></h2><h3 id="_1-1-1-雪崩问题" tabindex="-1"><a class="header-anchor" href="#_1-1-1-雪崩问题"><span>1.1.1.雪崩问题</span></a></h3><p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</p><figure><img src="'+e+'" alt="1533829099748" tabindex="0" loading="lazy"><figcaption>1533829099748</figcaption></figure><p>如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。</p>',7)),(0,n.Q3)(" more "),s[1]||(s[1]=(0,n.Fv)('<figure><img src="'+l+'" alt="1533829198240" tabindex="0" loading="lazy"><figcaption>1533829198240</figcaption></figure><p>但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：</p><figure><img src="'+t+'" alt="1533829307389" tabindex="0" loading="lazy"><figcaption>1533829307389</figcaption></figure><p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。</p><p>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：</p><figure><img src="'+p+'" alt="image-20210715172710340" tabindex="0" loading="lazy"><figcaption>image-20210715172710340</figcaption></figure><h3 id="_1-1-2-超时处理" tabindex="-1"><a class="header-anchor" href="#_1-1-2-超时处理"><span>1.1.2.超时处理</span></a></h3><p>解决雪崩问题的常见方式有四种：</p><p>•超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</p><figure><img src="'+h+'" alt="image-20210715172820438" tabindex="0" loading="lazy"><figcaption>image-20210715172820438</figcaption></figure><h3 id="_1-1-3-仓壁模式" tabindex="-1"><a class="header-anchor" href="#_1-1-3-仓壁模式"><span>1.1.3.仓壁模式</span></a></h3><p>方案2：仓壁模式</p><p>仓壁模式来源于船舱的设计：</p><figure><img src="'+r+'" alt="image-20210715172946352" tabindex="0" loading="lazy"><figcaption>image-20210715172946352</figcaption></figure><p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</p><p>于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</p><figure><img src="'+g+'" alt="image-20210715173215243" tabindex="0" loading="lazy"><figcaption>image-20210715173215243</figcaption></figure><h3 id="_1-1-4-断路器" tabindex="-1"><a class="header-anchor" href="#_1-1-4-断路器"><span>1.1.4.断路器</span></a></h3><p>断路器模式：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p><p>断路器会统计访问某个服务的请求数量，异常比例：</p><figure><img src="'+d+'" alt="image-20210715173327075" tabindex="0" loading="lazy"><figcaption>image-20210715173327075</figcaption></figure><p>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</p><figure><img src="'+k+'" alt="image-20210715173428073" tabindex="0" loading="lazy"><figcaption>image-20210715173428073</figcaption></figure><h3 id="_1-1-5-限流" tabindex="-1"><a class="header-anchor" href="#_1-1-5-限流"><span>1.1.5.限流</span></a></h3><p><strong>流量控制</strong>：限制业务访问的QPS，避免服务因流量的突增而故障。</p><figure><img src="'+A+'" alt="image-20210715173555158" tabindex="0" loading="lazy"><figcaption>image-20210715173555158</figcaption></figure><h3 id="_1-1-6-总结" tabindex="-1"><a class="header-anchor" href="#_1-1-6-总结"><span>1.1.6.总结</span></a></h3><p>什么是雪崩问题？</p><ul><li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</li></ul><p>可以认为：</p><p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种<strong>预防</strong>措施。</p><p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种<strong>补救</strong>措施。</p><h2 id="_1-2-服务保护技术对比" tabindex="-1"><a class="header-anchor" href="#_1-2-服务保护技术对比"><span>1.2.服务保护技术对比</span></a></h2><p>在SpringCloud当中支持多种服务保护技术：</p><ul><li><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener noreferrer">Netfix Hystrix</a></li><li><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener noreferrer">Sentinel</a></li><li><a href="https://github.com/resilience4j/resilience4j" target="_blank" rel="noopener noreferrer">Resilience4J</a></li></ul><p>早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：</p><table><thead><tr><th></th><th><strong>Sentinel</strong></th><th><strong>Hystrix</strong></th></tr></thead><tbody><tr><td>隔离策略</td><td>信号量隔离</td><td>线程池隔离/信号量隔离</td></tr><tr><td>熔断降级策略</td><td>基于慢调用比例或异常比例</td><td>基于失败比率</td></tr><tr><td>实时指标实现</td><td>滑动窗口</td><td>滑动窗口（基于 RxJava）</td></tr><tr><td>规则配置</td><td>支持多种数据源</td><td>支持多种数据源</td></tr><tr><td>扩展性</td><td>多个扩展点</td><td>插件的形式</td></tr><tr><td>基于注解的支持</td><td>支持</td><td>支持</td></tr><tr><td>限流</td><td>基于 QPS，支持基于调用关系的限流</td><td>有限的支持</td></tr><tr><td>流量整形</td><td>支持慢启动、匀速排队模式</td><td>不支持</td></tr><tr><td>系统自适应保护</td><td>支持</td><td>不支持</td></tr><tr><td>控制台</td><td>开箱即用，可配置规则、查看秒级监控、机器发现等</td><td>不完善</td></tr><tr><td>常见框架的适配</td><td>Servlet、Spring Cloud、Dubbo、gRPC 等</td><td>Servlet、Spring Cloud Netflix</td></tr></tbody></table><h2 id="_1-3-sentinel介绍和安装" tabindex="-1"><a class="header-anchor" href="#_1-3-sentinel介绍和安装"><span>1.3.Sentinel介绍和安装</span></a></h2><h3 id="_1-3-1-初识sentinel" tabindex="-1"><a class="header-anchor" href="#_1-3-1-初识sentinel"><span>1.3.1.初识Sentinel</span></a></h3><p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：https://sentinelguard.io/zh-cn/index.html</p><p>Sentinel 具有以下特征:</p><p>•<strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p><p>•<strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p><p>•<strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p><p>•<strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p><h3 id="_1-3-2-安装sentinel" tabindex="-1"><a class="header-anchor" href="#_1-3-2-安装sentinel"><span>1.3.2.安装Sentinel</span></a></h3><p>1）下载</p><p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreferrer">GitHub</a>下载。</p><p>课前资料也提供了下载好的jar包：</p><figure><img src="'+c+'" alt="image-20210715174252531" tabindex="0" loading="lazy"><figcaption>image-20210715174252531</figcaption></figure><p>2）运行</p><p>将jar包放到任意非中文目录，执行命令：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">java</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -jar</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sentinel-dashboard-1.8.1.jar</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p><table><thead><tr><th><strong>配置项</strong></th><th><strong>默认值</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>server.port</td><td>8080</td><td>服务端口</td></tr><tr><td>sentinel.dashboard.auth.username</td><td>sentinel</td><td>默认用户名</td></tr><tr><td>sentinel.dashboard.auth.password</td><td>sentinel</td><td>默认密码</td></tr></tbody></table><p>例如，修改端口：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">java</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -Dserver.port=8090</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -jar</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sentinel-dashboard-1.8.1.jar</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>3）访问</p><p>访问http://localhost:8080页面，就可以看到sentinel的控制台了：</p><figure><img src="'+o+'" alt="image-20210715190827846" tabindex="0" loading="lazy"><figcaption>image-20210715190827846</figcaption></figure><p>需要输入账号和密码，默认都是：sentinel</p><p>登录后，发现一片空白，什么都没有：</p><figure><img src="'+m+'" alt="image-20210715191134448" tabindex="0" loading="lazy"><figcaption>image-20210715191134448</figcaption></figure><p>这是因为我们还没有与微服务整合。</p><h2 id="_1-4-微服务整合sentinel" tabindex="-1"><a class="header-anchor" href="#_1-4-微服务整合sentinel"><span>1.4.微服务整合Sentinel</span></a></h2><p>我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：</p><p>1）引入sentinel依赖</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" data-title="xml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">&lt;!--sentinel--&gt;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;com.alibaba.cloud&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">groupId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;spring-cloud-starter-alibaba-sentinel&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">artifactId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dependency</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）配置控制台</p><p>修改application.yaml文件，添加下面内容：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8088</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  cloud</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      transport</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        dashboard</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">localhost:8080</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）访问order-service的任意端点</p><p>打开浏览器，访问http://localhost:8088/order/101，这样才能触发sentinel的监控。</p><p>然后再访问sentinel的控制台，查看效果：</p><figure><img src="'+y+'" alt="image-20210715191241799" tabindex="0" loading="lazy"><figcaption>image-20210715191241799</figcaption></figure><h1 id="_2-流量控制" tabindex="-1"><a class="header-anchor" href="#_2-流量控制"><span>2.流量控制</span></a></h1><p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p><h2 id="_2-1-簇点链路" tabindex="-1"><a class="header-anchor" href="#_2-1-簇点链路"><span>2.1.簇点链路</span></a></h2><p>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做<strong>簇点链路</strong>。簇点链路中被监控的每一个接口就是一个<strong>资源</strong>。</p><p>默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。</p>',80)),s[2]||(s[2]=(0,n.Lk)("p",{orderId:""},"例如，我们刚才访问的order-service中的OrderController中的端点：/order/",-1)),s[3]||(s[3]=(0,n.Fv)('<figure><img src="'+u+'" alt="image-20210715191757319" tabindex="0" loading="lazy"><figcaption>image-20210715191757319</figcaption></figure><p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</p><ul><li>流控：流量控制</li><li>降级：降级熔断</li><li>热点：热点参数限流，是限流的一种</li><li>授权：请求的权限控制</li></ul><h2 id="_2-1-快速入门" tabindex="-1"><a class="header-anchor" href="#_2-1-快速入门"><span>2.1.快速入门</span></a></h2><h3 id="_2-1-1-示例" tabindex="-1"><a class="header-anchor" href="#_2-1-1-示例"><span>2.1.1.示例</span></a></h3><p>点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。</p><figure><img src="'+u+'" alt="image-20210715191757319" tabindex="0" loading="lazy"><figcaption>image-20210715191757319</figcaption></figure><p>表单中可以填写限流规则，如下：</p><figure><img src="'+B+'" alt="image-20210715192010657" tabindex="0" loading="lazy"><figcaption>image-20210715192010657</figcaption></figure><p>其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。</p><h3 id="_2-1-2-练习" tabindex="-1"><a class="header-anchor" href="#_2-1-2-练习"><span>2.1.2.练习：</span></a></h3><p>需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。</p><p>1）首先在sentinel控制台添加限流规则</p><figure><img src="'+f+'" alt="image-20210715192455429" tabindex="0" loading="lazy"><figcaption>image-20210715192455429</figcaption></figure><p>2）利用jmeter测试</p><p>如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》</p><p>课前资料提供了编写好的Jmeter测试样例：</p><figure><img src="'+b+'" alt="image-20210715200431615" tabindex="0" loading="lazy"><figcaption>image-20210715200431615</figcaption></figure><p>打开jmeter，导入课前资料提供的测试样例：</p><figure><img src="'+v+'" alt="image-20210715200537171" tabindex="0" loading="lazy"><figcaption>image-20210715200537171</figcaption></figure><p>选择：</p><figure><img src="'+C+'" alt="image-20210715200635414" tabindex="0" loading="lazy"><figcaption>image-20210715200635414</figcaption></figure><p>20个用户，2秒内运行完，QPS是10，超过了5.</p><p>选中<code>流控入门，QPS&lt;5</code>右键运行：</p><figure><img src="'+F+'" alt="image-20210715200804594" tabindex="0" loading="lazy"><figcaption>image-20210715200804594</figcaption></figure><blockquote><p>注意，不要点击菜单中的执行按钮来运行。</p></blockquote><p>结果：</p><figure><img src="'+E+'" alt="image-20210715200853671" tabindex="0" loading="lazy"><figcaption>image-20210715200853671</figcaption></figure><p>可以看到，成功的请求每次只有5个</p><h2 id="_2-2-流控模式" tabindex="-1"><a class="header-anchor" href="#_2-2-流控模式"><span>2.2.流控模式</span></a></h2><p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p><ul><li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li><li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li><li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li></ul><figure><img src="'+D+'" alt="image-20210715201827886" tabindex="0" loading="lazy"><figcaption>image-20210715201827886</figcaption></figure><p>快速入门测试的就是直接模式。</p><h3 id="_2-2-1-关联模式" tabindex="-1"><a class="header-anchor" href="#_2-2-1-关联模式"><span>2.2.1.关联模式</span></a></h3><p><strong>关联模式</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p><p><strong>配置规则</strong>：</p><figure><img src="'+x+'" alt="image-20210715202540786" tabindex="0" loading="lazy"><figcaption>image-20210715202540786</figcaption></figure><p><strong>语法说明</strong>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。</p><p><strong>使用场景</strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p><p><strong>需求说明</strong>：</p><ul><li><p>在OrderController新建两个端点：/order/query和/order/update，无需实现业务</p></li><li><p>配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流</p></li></ul><p>1）定义/order/query端点，模拟订单查询</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/query&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> queryOrder</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;查询订单成功&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）定义/order/update端点，模拟订单更新</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/update&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> updateOrder</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;更新订单成功&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启服务，查看sentinel控制台的簇点链路：</p><figure><img src="'+Q+'" alt="image-20210716101805951" tabindex="0" loading="lazy"><figcaption>image-20210716101805951</figcaption></figure><p>3）配置流控规则</p><p>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：</p><figure><img src="'+w+'" alt="image-20210716101934499" tabindex="0" loading="lazy"><figcaption>image-20210716101934499</figcaption></figure><p>在表单中填写流控规则：</p><figure><img src="'+P+'" alt="image-20210716102103814" tabindex="0" loading="lazy"><figcaption>image-20210716102103814</figcaption></figure><p>4）在Jmeter测试</p><p>选择《流控模式-关联》：</p><figure><img src="'+z+'" alt="image-20210716102416266" tabindex="0" loading="lazy"><figcaption>image-20210716102416266</figcaption></figure><p>可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5</p><p>查看http请求：</p><figure><img src="'+_+'" alt="image-20210716102532554" tabindex="0" loading="lazy"><figcaption>image-20210716102532554</figcaption></figure><p>请求的目标是/order/update，这样这个断点就会触发阈值。</p><p>但限流的目标是/order/query，我们在浏览器访问，可以发现：</p><figure><img src="'+S+'" alt="image-20210716102636030" tabindex="0" loading="lazy"><figcaption>image-20210716102636030</figcaption></figure><p>确实被限流了。</p><p>5）总结</p><figure><img src="'+I+'" alt="image-20210716103143002" tabindex="0" loading="lazy"><figcaption>image-20210716103143002</figcaption></figure><h3 id="_2-2-2-链路模式" tabindex="-1"><a class="header-anchor" href="#_2-2-2-链路模式"><span>2.2.2.链路模式</span></a></h3><p><strong>链路模式</strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p><p><strong>配置示例</strong>：</p><p>例如有两条请求链路：</p><ul><li><p>/test1 --&gt; /common</p></li><li><p>/test2 --&gt; /common</p></li></ul><p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</p><figure><img src="'+H+'" alt="image-20210716103536346" tabindex="0" loading="lazy"><figcaption>image-20210716103536346</figcaption></figure><p><strong>实战案例</strong></p><p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p><p>步骤：</p><ol><li><p>在OrderService中添加一个queryGoods方法，不用实现业务</p></li><li><p>在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法</p></li><li><p>在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法</p></li><li><p>给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2</p></li></ol><p>实现：</p><h4 id="_1-添加查询商品方法" tabindex="-1"><a class="header-anchor" href="#_1-添加查询商品方法"><span>1）添加查询商品方法</span></a></h4><p>在order-service服务中，给OrderService类添加一个queryGoods方法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> queryGoods</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(){</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询商品&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-查询订单时-查询商品" tabindex="-1"><a class="header-anchor" href="#_2-查询订单时-查询商品"><span>2）查询订单时，查询商品</span></a></h4><p>在order-service的OrderController中，修改/order/query端点的业务逻辑：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/query&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> queryOrder</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 查询商品</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    orderService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">queryGoods</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 查询订单</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询订单&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;查询订单成功&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-新增订单-查询商品" tabindex="-1"><a class="header-anchor" href="#_3-新增订单-查询商品"><span>3）新增订单，查询商品</span></a></h4><p>在order-service的OrderController中，修改/order/save端点，模拟新增订单：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/save&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> saveOrder</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 查询商品</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    orderService</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">queryGoods</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 查询订单</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;新增订单&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;新增订单成功&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-给查询商品添加资源标记" tabindex="-1"><a class="header-anchor" href="#_4-给查询商品添加资源标记"><span>4）给查询商品添加资源标记</span></a></h4><p>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。</p><p>给OrderService的queryGoods方法添加@SentinelResource注解：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">SentinelResource</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;goods&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> queryGoods</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(){</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询商品&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p><p>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  cloud</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      web-context-unify</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 关闭context整合</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：</p><figure><img src="'+M+'" alt="image-20210716105227163" tabindex="0" loading="lazy"><figcaption>image-20210716105227163</figcaption></figure><h4 id="_5-添加流控规则" tabindex="-1"><a class="header-anchor" href="#_5-添加流控规则"><span>5）添加流控规则</span></a></h4><p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</p><figure><img src="'+j+'" alt="image-20210716105408723" tabindex="0" loading="lazy"><figcaption>image-20210716105408723</figcaption></figure><p>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。</p><h4 id="_6-jmeter测试" tabindex="-1"><a class="header-anchor" href="#_6-jmeter测试"><span>6）Jmeter测试</span></a></h4><p>选择《流控模式-链路》：</p><figure><img src="'+q+'" alt="image-20210716105612312" tabindex="0" loading="lazy"><figcaption>image-20210716105612312</figcaption></figure><p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</p><p>一个http请求是访问/order/save：</p><figure><img src="'+J+'" alt="image-20210716105812789" tabindex="0" loading="lazy"><figcaption>image-20210716105812789</figcaption></figure><p>运行的结果：</p><figure><img src="'+O+'" alt="image-20210716110027064" tabindex="0" loading="lazy"><figcaption>image-20210716110027064</figcaption></figure><p>完全不受影响。</p><p>另一个是访问/order/query：</p><figure><img src="'+T+'" alt="image-20210716105855951" tabindex="0" loading="lazy"><figcaption>image-20210716105855951</figcaption></figure><p>运行结果：</p><figure><img src="'+R+'" alt="image-20210716105956401" tabindex="0" loading="lazy"><figcaption>image-20210716105956401</figcaption></figure><p>每次只有2个通过。</p><h3 id="_2-2-3-总结" tabindex="-1"><a class="header-anchor" href="#_2-2-3-总结"><span>2.2.3.总结</span></a></h3><p>流控模式有哪些？</p><p>•直接：对当前资源限流</p><p>•关联：高优先级资源触发阈值，对低优先级资源限流。</p><p>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</p><h2 id="_2-3-流控效果" tabindex="-1"><a class="header-anchor" href="#_2-3-流控效果"><span>2.3.流控效果</span></a></h2><p>在流控的高级选项中，还有一个流控效果选项：</p><figure><img src="'+Y+'" alt="image-20210716110225104" tabindex="0" loading="lazy"><figcaption>image-20210716110225104</figcaption></figure><p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p><ul><li><p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</p></li><li><p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值(慢开始)。</p></li><li><p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p></li></ul><h3 id="_2-3-1-warm-up" tabindex="-1"><a class="header-anchor" href="#_2-3-1-warm-up"><span>2.3.1.warm up</span></a></h3><p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p><p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</p><p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.</p><figure><img src="'+L+'" alt="image-20210716110629796" tabindex="0" loading="lazy"><figcaption>image-20210716110629796</figcaption></figure><p><strong>案例</strong></p><p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</p><h4 id="_1-配置流控规则" tabindex="-1"><a class="header-anchor" href="#_1-配置流控规则"><span>1）配置流控规则：</span></a></h4><figure><img src="'+G+'" alt="image-20210716111012387" tabindex="0" loading="lazy"><figcaption>image-20210716111012387</figcaption></figure><h4 id="_2-jmeter测试" tabindex="-1"><a class="header-anchor" href="#_2-jmeter测试"><span>2）Jmeter测试</span></a></h4><p>选择《流控效果，warm up》：</p><figure><img src="'+U+'" alt="image-20210716111136699" tabindex="0" loading="lazy"><figcaption>image-20210716111136699</figcaption></figure><p>QPS为10.</p><p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</p><figure><img src="'+Z+'" alt="image-20210716111303701" tabindex="0" loading="lazy"><figcaption>image-20210716111303701</figcaption></figure><p>随着时间推移，成功比例越来越高：</p><figure><img src="'+N+'" alt="image-20210716111404717" tabindex="0" loading="lazy"><figcaption>image-20210716111404717</figcaption></figure><p>到Sentinel控制台查看实时监控：</p><figure><img src="'+K+'" alt="image-20210716111526480" tabindex="0" loading="lazy"><figcaption>image-20210716111526480</figcaption></figure><p>一段时间后：</p><figure><img src="'+X+'" alt="image-20210716111658541" tabindex="0" loading="lazy"><figcaption>image-20210716111658541</figcaption></figure><h3 id="_2-3-2-排队等待" tabindex="-1"><a class="header-anchor" href="#_2-3-2-排队等待"><span>2.3.2.排队等待</span></a></h3><p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</p><p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p><p>工作原理</p><p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p><p>那什么叫做预期等待时长呢？</p><p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p><ul><li>第6个请求的<strong>预期等待时长</strong> = 200 * （6 - 1） = 1000ms</li><li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</li></ul><p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p><figure><img src="data:image/png;base64,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" alt="image-20210716113147176" tabindex="0" loading="lazy"><figcaption>image-20210716113147176</figcaption></figure><p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p><figure><img src="data:image/png;base64,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" alt="image-20210716113426524" tabindex="0" loading="lazy"><figcaption>image-20210716113426524</figcaption></figure><p>平滑的QPS曲线，对于服务器来说是更友好的。</p><p><strong>案例</strong></p><p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</p><h4 id="_1-添加流控规则" tabindex="-1"><a class="header-anchor" href="#_1-添加流控规则"><span>1）添加流控规则</span></a></h4><figure><img src="'+V+'" alt="image-20210716114048918" tabindex="0" loading="lazy"><figcaption>image-20210716114048918</figcaption></figure><h4 id="_2-jmeter测试-1" tabindex="-1"><a class="header-anchor" href="#_2-jmeter测试-1"><span>2）Jmeter测试</span></a></h4><p>选择《流控效果，队列》：</p><figure><img src="'+W+'" alt="image-20210716114243558" tabindex="0" loading="lazy"><figcaption>image-20210716114243558</figcaption></figure><p>QPS为15，已经超过了我们设定的10。</p><p>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。</p><p>但是我们看看队列模式的运行结果：</p><figure><img src="'+$+'" alt="image-20210716114429361" tabindex="0" loading="lazy"><figcaption>image-20210716114429361</figcaption></figure><p>全部都通过了。</p><p>再去sentinel查看实时监控的QPS曲线：</p><figure><img src="'+ii+'" alt="image-20210716114522935" tabindex="0" loading="lazy"><figcaption>image-20210716114522935</figcaption></figure><p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p><p>当队列满了以后，才会有部分请求失败：</p><figure><img src="'+si+'" alt="image-20210716114651137" tabindex="0" loading="lazy"><figcaption>image-20210716114651137</figcaption></figure><h3 id="_2-3-3-总结" tabindex="-1"><a class="header-anchor" href="#_2-3-3-总结"><span>2.3.3.总结</span></a></h3><p>流控效果有哪些？</p><ul><li><p>快速失败：QPS超过阈值时，拒绝新的请求</p></li><li><p>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</p></li><li><p>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</p></li></ul><h2 id="_2-4-热点参数限流" tabindex="-1"><a class="header-anchor" href="#_2-4-热点参数限流"><span>2.4.热点参数限流</span></a></h2><p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p><h3 id="_2-4-1-全局参数限流" tabindex="-1"><a class="header-anchor" href="#_2-4-1-全局参数限流"><span>2.4.1.全局参数限流</span></a></h3><p>例如，一个根据id查询商品的接口：</p><figure><img src="'+ai+'" alt="image-20210716115014663" tabindex="0" loading="lazy"><figcaption>image-20210716115014663</figcaption></figure><p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p><figure><img src="'+ni+'" alt="image-20210716115131463" tabindex="0" loading="lazy"><figcaption>image-20210716115131463</figcaption></figure><p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p><p>配置示例：</p><figure><img src="'+ei+'" alt="image-20210716115232426" tabindex="0" loading="lazy"><figcaption>image-20210716115232426</figcaption></figure><p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5</p><h3 id="_2-4-2-热点参数限流" tabindex="-1"><a class="header-anchor" href="#_2-4-2-热点参数限流"><span>2.4.2.热点参数限流</span></a></h3><p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</p><p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p><figure><img src="'+li+'" alt="image-20210716115717523" tabindex="0" loading="lazy"><figcaption>image-20210716115717523</figcaption></figure><p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</p><p>•如果参数值是100，则每1秒允许的QPS为10</p><p>•如果参数值是101，则每1秒允许的QPS为15</p><h3 id="_2-4-4-案例" tabindex="-1"><a class="header-anchor" href="#_2-4-4-案例"><span>2.4.4.案例</span></a></h3><p><strong>案例需求</strong>：给/order/{orderId}这个资源添加热点参数限流，规则如下：</p><p>•默认的热点参数规则是每1秒请求量不超过2</p><p>•给102这个参数设置例外：每1秒请求量不超过4</p><p>•给103这个参数设置例外：每1秒请求量不超过10</p><p><strong>注意事项</strong>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源</p><h4 id="_1-标记资源" tabindex="-1"><a class="header-anchor" href="#_1-标记资源"><span>1）标记资源</span></a></h4><p>给order-service中的OrderController中的/order/{orderId}资源添加注解：</p><figure><img src="'+ti+'" alt="image-20210716120033572" tabindex="0" loading="lazy"><figcaption>image-20210716120033572</figcaption></figure><h4 id="_2-热点参数限流规则" tabindex="-1"><a class="header-anchor" href="#_2-热点参数限流规则"><span>2）热点参数限流规则</span></a></h4><p>访问该接口，可以看到我们标记的hot资源出现了：</p><figure><img src="'+pi+'" alt="image-20210716120208509" tabindex="0" loading="lazy"><figcaption>image-20210716120208509</figcaption></figure><p>这里不要点击hot后面的按钮，页面有BUG</p><p>点击左侧菜单中<strong>热点规则</strong>菜单：</p><figure><img src="'+hi+'" alt="image-20210716120319009" tabindex="0" loading="lazy"><figcaption>image-20210716120319009</figcaption></figure><p>点击新增，填写表单：</p><figure><img src="'+ri+'" alt="image-20210716120536714" tabindex="0" loading="lazy"><figcaption>image-20210716120536714</figcaption></figure><h4 id="_3-jmeter测试" tabindex="-1"><a class="header-anchor" href="#_3-jmeter测试"><span>3）Jmeter测试</span></a></h4><p>选择《热点参数限流 QPS1》：</p><figure><img src="'+gi+'" alt="image-20210716120754527" tabindex="0" loading="lazy"><figcaption>image-20210716120754527</figcaption></figure><p>这里发起请求的QPS为5.</p><p>包含3个http请求：</p><p>普通参数，QPS阈值为2</p><figure><img src="'+di+'" alt="image-20210716120840501" tabindex="0" loading="lazy"><figcaption>image-20210716120840501</figcaption></figure><p>运行结果：</p><figure><img src="'+ki+'" alt="image-20210716121105567" tabindex="0" loading="lazy"><figcaption>image-20210716121105567</figcaption></figure><p>例外项，QPS阈值为4</p><figure><img src="'+Ai+'" alt="image-20210716120900365" tabindex="0" loading="lazy"><figcaption>image-20210716120900365</figcaption></figure><p>运行结果：</p><figure><img src="'+ci+'" alt="image-20210716121201630" tabindex="0" loading="lazy"><figcaption>image-20210716121201630</figcaption></figure><p>例外项，QPS阈值为10</p><figure><img src="'+oi+'" alt="image-20210716120919131" tabindex="0" loading="lazy"><figcaption>image-20210716120919131</figcaption></figure><p>运行结果：</p><figure><img src="'+mi+'" alt="image-20210716121220305" tabindex="0" loading="lazy"><figcaption>image-20210716121220305</figcaption></figure><h1 id="_3-隔离和降级" tabindex="-1"><a class="header-anchor" href="#_3-隔离和降级"><span>3.隔离和降级</span></a></h1><p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</p><p>而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p><p><strong>线程隔离</strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p><figure><img src="'+g+'" alt="image-20210715173215243" tabindex="0" loading="lazy"><figcaption>image-20210715173215243</figcaption></figure><p><strong>熔断降级</strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p><figure><img src="'+k+'" alt="image-20210715173428073" tabindex="0" loading="lazy"><figcaption>image-20210715173428073</figcaption></figure><p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong> 发起远程调用时做线程隔离、或者服务熔断。</p><p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</p><h2 id="_3-1-feignclient整合sentinel" tabindex="-1"><a class="header-anchor" href="#_3-1-feignclient整合sentinel"><span>3.1.FeignClient整合Sentinel</span></a></h2><p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p><h3 id="_3-1-1-修改配置-开启sentinel功能" tabindex="-1"><a class="header-anchor" href="#_3-1-1-修改配置-开启sentinel功能"><span>3.1.1.修改配置，开启sentinel功能</span></a></h3><p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">feign</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 开启feign对sentinel的支持</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-2-编写失败降级逻辑" tabindex="-1"><a class="header-anchor" href="#_3-1-2-编写失败降级逻辑"><span>3.1.2.编写失败降级逻辑</span></a></h3><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p><p>给FeignClient编写失败后的降级逻辑</p><p>①方式一：FallbackClass，无法对远程调用的异常做处理</p><p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p><p>这里我们演示方式二的失败降级处理。</p><p><strong>步骤一</strong>：在feing-api项目中定义类，实现FallbackFactory：</p><figure><img src="'+yi+'" alt="image-20210716122403502" tabindex="0" loading="lazy"><figcaption>image-20210716122403502</figcaption></figure><p>代码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> cn.itcast.feign.clients.fallback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> cn.itcast.feign.clients.UserClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> cn.itcast.feign.pojo.User</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> feign.hystrix.FallbackFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> lombok.extern.slf4j.Slf4j</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Slf4j</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserClientFallbackFactory</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> FallbackFactory</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">UserClient</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserClient</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Throwable</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> throwable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> UserClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> User</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> findById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;查询用户异常&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, throwable);</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> User</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        };</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>步骤二</strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Bean</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserClientFallbackFactory</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> userClientFallbackFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(){</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> UserClientFallbackFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>步骤三</strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> cn.itcast.feign.clients.fallback.UserClientFallbackFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> cn.itcast.feign.pojo.User</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.cloud.openfeign.FeignClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.web.bind.annotation.GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.web.bind.annotation.PathVariable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">FeignClient</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;userservice&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> fallbackFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> UserClientFallbackFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> interface</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UserClient</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">GetMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/user/{id}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    User</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> findById</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">PathVariable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Long</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</p><figure><img src="'+ui+'" alt="image-20210716123705780" tabindex="0" loading="lazy"><figcaption>image-20210716123705780</figcaption></figure><h3 id="_3-1-3-总结" tabindex="-1"><a class="header-anchor" href="#_3-1-3-总结"><span>3.1.3.总结</span></a></h3><p>Sentinel支持的雪崩解决方案：</p><ul><li>线程隔离（仓壁模式）</li><li>降级熔断</li></ul><p>Feign整合Sentinel的步骤：</p><ul><li>在application.yml中配置：feign.sentienl.enable=true</li><li>给FeignClient编写FallbackFactory并注册为Bean</li><li>将FallbackFactory配置到FeignClient</li></ul><h2 id="_3-2-线程隔离-舱壁模式" tabindex="-1"><a class="header-anchor" href="#_3-2-线程隔离-舱壁模式"><span>3.2.线程隔离（舱壁模式）</span></a></h2><h3 id="_3-2-1-线程隔离的实现方式" tabindex="-1"><a class="header-anchor" href="#_3-2-1-线程隔离的实现方式"><span>3.2.1.线程隔离的实现方式</span></a></h3><p>线程隔离有两种方式实现：</p><ul><li><p>线程池隔离</p></li><li><p>信号量隔离（Sentinel默认采用）</p></li></ul><p>如图：</p><figure><img src="'+Bi+'" alt="image-20210716123036937" tabindex="0" loading="lazy"><figcaption>image-20210716123036937</figcaption></figure><p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p><p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p><p>两者的优缺点：</p><figure><img src="'+fi+'" alt="image-20210716123240518" tabindex="0" loading="lazy"><figcaption>image-20210716123240518</figcaption></figure><h3 id="_3-2-2-sentinel的线程隔离" tabindex="-1"><a class="header-anchor" href="#_3-2-2-sentinel的线程隔离"><span>3.2.2.sentinel的线程隔离</span></a></h3><p><strong>用法说明</strong>：</p><p>在添加限流规则时，可以选择两种阈值类型：</p><figure><img src="'+bi+'" alt="image-20210716123411217" tabindex="0" loading="lazy"><figcaption>image-20210716123411217</figcaption></figure><ul><li><p>QPS：就是每秒的请求数，在快速入门中已经演示过</p></li><li><p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p></li></ul><p><strong>案例需求</strong>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。</p><h4 id="_1-配置隔离规则" tabindex="-1"><a class="header-anchor" href="#_1-配置隔离规则"><span>1）配置隔离规则</span></a></h4><p>选择feign接口后面的流控按钮：</p><figure><img src="'+vi+'" alt="image-20210716123831992" tabindex="0" loading="lazy"><figcaption>image-20210716123831992</figcaption></figure><p>填写表单：</p><figure><img src="'+Ci+'" alt="image-20210716123936844" tabindex="0" loading="lazy"><figcaption>image-20210716123936844</figcaption></figure><h4 id="_2-jmeter测试-2" tabindex="-1"><a class="header-anchor" href="#_2-jmeter测试-2"><span>2）Jmeter测试</span></a></h4><p>选择《阈值类型-线程数&lt;2》：</p><figure><img src="'+Fi+'" alt="image-20210716124229894" tabindex="0" loading="lazy"><figcaption>image-20210716124229894</figcaption></figure><p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</p><p>查看运行结果：</p><figure><img src="'+Ei+'" alt="image-20210716124147820" tabindex="0" loading="lazy"><figcaption>image-20210716124147820</figcaption></figure><p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。</p><h3 id="_3-2-3-总结" tabindex="-1"><a class="header-anchor" href="#_3-2-3-总结"><span>3.2.3.总结</span></a></h3><p>线程隔离的两种手段是？</p><ul><li><p>信号量隔离</p></li><li><p>线程池隔离</p></li></ul><p>信号量隔离的特点是？</p><ul><li>基于计数器模式，简单，开销小</li></ul><p>线程池隔离的特点是？</p><ul><li>基于线程池模式，有额外开销，但隔离控制更强</li></ul><h2 id="_3-3-熔断降级" tabindex="-1"><a class="header-anchor" href="#_3-3-熔断降级"><span>3.3.熔断降级</span></a></h2><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p><p>断路器控制熔断和放行是通过状态机来完成的：</p><figure><img src="'+Di+'" alt="image-20210716130958518" tabindex="0" loading="lazy"><figcaption>image-20210716130958518</figcaption></figure><p>状态机包括三个状态：</p><ul><li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li><li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li><li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 <ul><li>请求成功：则切换到closed状态</li><li>请求失败：则切换到open状态</li></ul></li></ul><p>断路器熔断策略有三种：慢调用、异常比例、异常数</p><h3 id="_3-3-1-慢调用" tabindex="-1"><a class="header-anchor" href="#_3-3-1-慢调用"><span>3.3.1.慢调用</span></a></h3><p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p><p>例如：</p><figure><img src="'+xi+'" alt="image-20210716145934347" tabindex="0" loading="lazy"><figcaption>image-20210716145934347</figcaption></figure><p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p><p><strong>案例</strong></p><p>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5</p><h4 id="_1-设置慢调用" tabindex="-1"><a class="header-anchor" href="#_1-设置慢调用"><span>1）设置慢调用</span></a></h4><p>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：</p><figure><img src="'+Qi+'" alt="image-20210716150234787" tabindex="0" loading="lazy"><figcaption>image-20210716150234787</figcaption></figure><p>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：</p><figure><img src="'+wi+'" alt="image-20210716150510956" tabindex="0" loading="lazy"><figcaption>image-20210716150510956</figcaption></figure><p>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；</p><figure><img src="'+Pi+'" alt="image-20210716150605208" tabindex="0" loading="lazy"><figcaption>image-20210716150605208</figcaption></figure><h4 id="_2-设置熔断规则" tabindex="-1"><a class="header-anchor" href="#_2-设置熔断规则"><span>2）设置熔断规则</span></a></h4><p>下面，给feign接口设置降级规则：</p><figure><img src="'+zi+'" alt="image-20210716150654094" tabindex="0" loading="lazy"><figcaption>image-20210716150654094</figcaption></figure><p>规则：</p><figure><img src="'+_i+'" alt="image-20210716150740434" tabindex="0" loading="lazy"><figcaption>image-20210716150740434</figcaption></figure><p>超过50ms的请求都会被认为是慢请求</p><h4 id="_3-测试" tabindex="-1"><a class="header-anchor" href="#_3-测试"><span>3）测试</span></a></h4><p>在浏览器访问：http://localhost:8088/order/101，快速刷新5次，可以发现：</p><figure><img src="'+Si+'" alt="image-20210716150911004" tabindex="0" loading="lazy"><figcaption>image-20210716150911004</figcaption></figure><p>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null</p><p>在浏览器访问：http://localhost:8088/order/102，竟然也被熔断了：</p><figure><img src="'+Ii+'" alt="image-20210716151107785" tabindex="0" loading="lazy"><figcaption>image-20210716151107785</figcaption></figure><h3 id="_3-3-2-异常比例、异常数" tabindex="-1"><a class="header-anchor" href="#_3-3-2-异常比例、异常数"><span>3.3.2.异常比例、异常数</span></a></h3><p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p><p>例如，一个异常比例设置：</p><figure><img src="'+Hi+'" alt="image-20210716131430682" tabindex="0" loading="lazy"><figcaption>image-20210716131430682</figcaption></figure><p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p><p>一个异常数设置：</p><figure><img src="'+Mi+'" alt="image-20210716131522912" tabindex="0" loading="lazy"><figcaption>image-20210716131522912</figcaption></figure><p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</p><p><strong>案例</strong></p><p>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</p><h4 id="_1-设置异常请求" tabindex="-1"><a class="header-anchor" href="#_1-设置异常请求"><span>1）设置异常请求</span></a></h4><p>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</p><figure><img src="'+ji+'" alt="image-20210716151348183" tabindex="0" loading="lazy"><figcaption>image-20210716151348183</figcaption></figure><p>也就是说，id 为 2时，就会触发异常</p><h4 id="_2-设置熔断规则-1" tabindex="-1"><a class="header-anchor" href="#_2-设置熔断规则-1"><span>2）设置熔断规则</span></a></h4><p>下面，给feign接口设置降级规则：</p><figure><img src="'+zi+'" alt="image-20210716150654094" tabindex="0" loading="lazy"><figcaption>image-20210716150654094</figcaption></figure><p>规则：</p><figure><img src="'+qi+'" alt="image-20210716151538785" tabindex="0" loading="lazy"><figcaption>image-20210716151538785</figcaption></figure><p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。</p><h4 id="_3-测试-1" tabindex="-1"><a class="header-anchor" href="#_3-测试-1"><span>3）测试</span></a></h4><p>在浏览器快速访问：http://localhost:8088/order/102，快速刷新5次，触发熔断：</p><figure><img src="'+Ji+'" alt="image-20210716151722916" tabindex="0" loading="lazy"><figcaption>image-20210716151722916</figcaption></figure><p>此时，我们去访问本来应该正常的103：</p><figure><img src="'+Oi+'" alt="image-20210716151844817" tabindex="0" loading="lazy"><figcaption>image-20210716151844817</figcaption></figure><h1 id="_4-授权规则" tabindex="-1"><a class="header-anchor" href="#_4-授权规则"><span>4.授权规则</span></a></h1><p>授权规则可以对请求方来源做判断和控制。</p><h2 id="_4-1-授权规则" tabindex="-1"><a class="header-anchor" href="#_4-1-授权规则"><span>4.1.授权规则</span></a></h2><h3 id="_4-1-1-基本规则" tabindex="-1"><a class="header-anchor" href="#_4-1-1-基本规则"><span>4.1.1.基本规则</span></a></h3><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p><ul><li><p>白名单：来源（origin）在白名单内的调用者允许访问</p></li><li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p></li></ul><p>点击左侧菜单的授权，可以看到授权规则：</p><figure><img src="'+Ti+'" alt="image-20210716152010750" tabindex="0" loading="lazy"><figcaption>image-20210716152010750</figcaption></figure>',365)),s[4]||(s[4]=(0,n.Lk)("ul",null,[(0,n.Lk)("li",{orderId:""},[(0,n.Lk)("p",null,"资源名：就是受保护的资源，例如/order/")]),(0,n.Lk)("li",null,[(0,n.Lk)("p",null,"流控应用：是来源者的名单，"),(0,n.Lk)("ul",null,[(0,n.Lk)("li",null,"如果是勾选白名单，则名单中的来源被许可访问。"),(0,n.Lk)("li",null,"如果是勾选黑名单，则名单中的来源被禁止访问。")])])],-1)),s[5]||(s[5]=(0,n.Fv)('<p>比如：</p><figure><img src="'+Ri+'" alt="image-20210716152349191" tabindex="0" loading="lazy"><figcaption>image-20210716152349191</figcaption></figure><p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p><h3 id="_4-1-2-如何获取origin" tabindex="-1"><a class="header-anchor" href="#_4-1-2-如何获取origin"><span>4.1.2.如何获取origin</span></a></h3><p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> interface</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RequestOriginParser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    /**</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     * 从请求request对象中获取origin，获取方式自定义</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     */</span></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> parseOrigin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HttpServletRequest</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</p><p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</p><p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的origin</strong>。</p><p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> cn.itcast.order.sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.stereotype.Component</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.util.StringUtils</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> javax.servlet.http.HttpServletRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HeaderOriginParser</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> RequestOriginParser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> parseOrigin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HttpServletRequest</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 1.获取请求头</span></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> origin</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getHeader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;origin&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 2.非空判断</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">StringUtils</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">isEmpty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(origin)) {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            origin </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;blank&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> origin;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们会尝试从request-header中获取origin值。</p><h3 id="_4-1-3-给网关添加请求头" tabindex="-1"><a class="header-anchor" href="#_4-1-3-给网关添加请求头"><span>4.1.3.给网关添加请求头</span></a></h3><p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让<strong>所有从gateway路由到微服务的请求都带上origin头</strong>。</p><p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</p><p>修改gateway服务中的application.yml，添加一个defaultFilter：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spring</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  cloud</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    gateway</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      default-filters</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">AddRequestHeader=origin,gateway</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      routes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       # ...略</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</p><h3 id="_4-1-4-配置授权规则" tabindex="-1"><a class="header-anchor" href="#_4-1-4-配置授权规则"><span>4.1.4.配置授权规则</span></a></h3><p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</p><figure><img src="'+Yi+'" alt="image-20210716153250134" tabindex="0" loading="lazy"><figcaption>image-20210716153250134</figcaption></figure><p>配置如下：</p><figure><img src="'+Li+'" alt="image-20210716153301069" tabindex="0" loading="lazy"><figcaption>image-20210716153301069</figcaption></figure><p>现在，我们直接跳过网关，访问order-service服务：</p><figure><img src="'+Gi+'" alt="image-20210716153348396" tabindex="0" loading="lazy"><figcaption>image-20210716153348396</figcaption></figure><p>通过网关访问：</p><figure><img src="'+Ui+'" alt="image-20210716153434095" tabindex="0" loading="lazy"><figcaption>image-20210716153434095</figcaption></figure><h2 id="_4-2-自定义异常结果" tabindex="-1"><a class="header-anchor" href="#_4-2-自定义异常结果"><span>4.2.自定义异常结果</span></a></h2><p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p><h3 id="_4-2-1-异常类型" tabindex="-1"><a class="header-anchor" href="#_4-2-1-异常类型"><span>4.2.1.异常类型</span></a></h3><p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> interface</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BlockExceptionHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    /**</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span>\n<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     */</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> handle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HttpServletRequest</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HttpServletResponse</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> response</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BlockException</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个方法有三个参数：</p><ul><li>HttpServletRequest request：request对象</li><li>HttpServletResponse response：response对象</li><li>BlockException e：被sentinel拦截时抛出的异常</li></ul><p>这里的BlockException包含多个不同的子类：</p><table><thead><tr><th><strong>异常</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>FlowException</td><td>限流异常</td></tr><tr><td>ParamFlowException</td><td>热点参数限流的异常</td></tr><tr><td>DegradeException</td><td>降级异常</td></tr><tr><td>AuthorityException</td><td>授权规则异常</td></tr><tr><td>SystemBlockException</td><td>系统规则异常</td></tr></tbody></table><h3 id="_4-2-2-自定义异常处理" tabindex="-1"><a class="header-anchor" href="#_4-2-2-自定义异常处理"><span>4.2.2.自定义异常处理</span></a></h3><p>下面，我们就在order-service定义一个自定义异常处理类：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> cn.itcast.order.sentinel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.slots.block.BlockException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.slots.block.authority.AuthorityException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.slots.block.degrade.DegradeException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.slots.block.flow.FlowException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> org.springframework.stereotype.Component</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> javax.servlet.http.HttpServletRequest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> javax.servlet.http.HttpServletResponse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Component</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SentinelExceptionHandler</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BlockExceptionHandler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Override</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> handle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HttpServletRequest</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HttpServletResponse</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> response</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BlockException</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> throws</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> msg</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;未知异常&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 429</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (e </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> FlowException) {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            msg </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;请求被限流了&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (e </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ParamFlowException) {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            msg </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;请求被热点参数限流&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (e </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> DegradeException) {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            msg </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;请求被降级了&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (e </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">instanceof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> AuthorityException) {</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            msg </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;没有权限访问&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            status </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 401</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        response</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setContentType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;application/json;charset=utf-8&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        response</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(status);</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        response</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getWriter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;{</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">msg</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> msg </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;, </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">status</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">: &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> status </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启测试，在不同场景下，会返回不同的异常消息.</p><p>限流：</p><figure><img src="'+Zi+'" alt="image-20210716153938887" tabindex="0" loading="lazy"><figcaption>image-20210716153938887</figcaption></figure><p>授权拦截时：</p><figure><img src="'+Ni+'" alt="image-20210716154012736" tabindex="0" loading="lazy"><figcaption>image-20210716154012736</figcaption></figure><h1 id="_5-规则持久化" tabindex="-1"><a class="header-anchor" href="#_5-规则持久化"><span>5.规则持久化</span></a></h1><p>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p><h2 id="_5-1-规则管理模式" tabindex="-1"><a class="header-anchor" href="#_5-1-规则管理模式"><span>5.1.规则管理模式</span></a></h2><p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</p><ul><li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</li><li>pull模式</li><li>push模式</li></ul><h3 id="_5-1-1-pull模式" tabindex="-1"><a class="header-anchor" href="#_5-1-1-pull模式"><span>5.1.1.pull模式</span></a></h3><p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p><figure><img src="'+Ki+'" alt="image-20210716154155238" tabindex="0" loading="lazy"><figcaption>image-20210716154155238</figcaption></figure><h3 id="_5-1-2-push模式" tabindex="-1"><a class="header-anchor" href="#_5-1-2-push模式"><span>5.1.2.push模式</span></a></h3><p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</p><figure><img src="'+Xi+'" alt="image-20210716154215456" tabindex="0" loading="lazy"><figcaption>image-20210716154215456</figcaption></figure><h2 id="_5-2-实现push模式" tabindex="-1"><a class="header-anchor" href="#_5-2-实现push模式"><span>5.2.实现push模式</span></a></h2><p>详细步骤可以参考课前资料的《sentinel规则持久化》：</p><figure><img src="'+Vi+'" alt="image-20210716154255466" tabindex="0" loading="lazy"><figcaption>image-20210716154255466</figcaption></figure>',58))])}]]),is=JSON.parse('{"path":"/SpringCloud/%E9%AB%98%E7%BA%A7/Sentinel/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4.html","title":"微服务保护","lang":"zh-CN","frontmatter":{"icon":"fa-solid fa-web-awesome","date":"2025-02-25T00:00:00.000Z","category":["SpringCloud高级篇"],"tag":["阅读完毕","讲义","Sentinel"],"gitInclude":[]},"headers":[{"level":2,"title":"1.1.雪崩问题及解决方案","slug":"_1-1-雪崩问题及解决方案","link":"#_1-1-雪崩问题及解决方案","children":[{"level":3,"title":"1.1.1.雪崩问题","slug":"_1-1-1-雪崩问题","link":"#_1-1-1-雪崩问题","children":[]},{"level":3,"title":"1.1.2.超时处理","slug":"_1-1-2-超时处理","link":"#_1-1-2-超时处理","children":[]},{"level":3,"title":"1.1.3.仓壁模式","slug":"_1-1-3-仓壁模式","link":"#_1-1-3-仓壁模式","children":[]},{"level":3,"title":"1.1.4.断路器","slug":"_1-1-4-断路器","link":"#_1-1-4-断路器","children":[]},{"level":3,"title":"1.1.5.限流","slug":"_1-1-5-限流","link":"#_1-1-5-限流","children":[]},{"level":3,"title":"1.1.6.总结","slug":"_1-1-6-总结","link":"#_1-1-6-总结","children":[]}]},{"level":2,"title":"1.2.服务保护技术对比","slug":"_1-2-服务保护技术对比","link":"#_1-2-服务保护技术对比","children":[]},{"level":2,"title":"1.3.Sentinel介绍和安装","slug":"_1-3-sentinel介绍和安装","link":"#_1-3-sentinel介绍和安装","children":[{"level":3,"title":"1.3.1.初识Sentinel","slug":"_1-3-1-初识sentinel","link":"#_1-3-1-初识sentinel","children":[]},{"level":3,"title":"1.3.2.安装Sentinel","slug":"_1-3-2-安装sentinel","link":"#_1-3-2-安装sentinel","children":[]}]},{"level":2,"title":"1.4.微服务整合Sentinel","slug":"_1-4-微服务整合sentinel","link":"#_1-4-微服务整合sentinel","children":[]},{"level":2,"title":"2.1.簇点链路","slug":"_2-1-簇点链路","link":"#_2-1-簇点链路","children":[]},{"level":2,"title":"2.1.快速入门","slug":"_2-1-快速入门","link":"#_2-1-快速入门","children":[{"level":3,"title":"2.1.1.示例","slug":"_2-1-1-示例","link":"#_2-1-1-示例","children":[]},{"level":3,"title":"2.1.2.练习：","slug":"_2-1-2-练习","link":"#_2-1-2-练习","children":[]}]},{"level":2,"title":"2.2.流控模式","slug":"_2-2-流控模式","link":"#_2-2-流控模式","children":[{"level":3,"title":"2.2.1.关联模式","slug":"_2-2-1-关联模式","link":"#_2-2-1-关联模式","children":[]},{"level":3,"title":"2.2.2.链路模式","slug":"_2-2-2-链路模式","link":"#_2-2-2-链路模式","children":[]},{"level":3,"title":"2.2.3.总结","slug":"_2-2-3-总结","link":"#_2-2-3-总结","children":[]}]},{"level":2,"title":"2.3.流控效果","slug":"_2-3-流控效果","link":"#_2-3-流控效果","children":[{"level":3,"title":"2.3.1.warm up","slug":"_2-3-1-warm-up","link":"#_2-3-1-warm-up","children":[]},{"level":3,"title":"2.3.2.排队等待","slug":"_2-3-2-排队等待","link":"#_2-3-2-排队等待","children":[]},{"level":3,"title":"2.3.3.总结","slug":"_2-3-3-总结","link":"#_2-3-3-总结","children":[]}]},{"level":2,"title":"2.4.热点参数限流","slug":"_2-4-热点参数限流","link":"#_2-4-热点参数限流","children":[{"level":3,"title":"2.4.1.全局参数限流","slug":"_2-4-1-全局参数限流","link":"#_2-4-1-全局参数限流","children":[]},{"level":3,"title":"2.4.2.热点参数限流","slug":"_2-4-2-热点参数限流","link":"#_2-4-2-热点参数限流","children":[]},{"level":3,"title":"2.4.4.案例","slug":"_2-4-4-案例","link":"#_2-4-4-案例","children":[]}]},{"level":2,"title":"3.1.FeignClient整合Sentinel","slug":"_3-1-feignclient整合sentinel","link":"#_3-1-feignclient整合sentinel","children":[{"level":3,"title":"3.1.1.修改配置，开启sentinel功能","slug":"_3-1-1-修改配置-开启sentinel功能","link":"#_3-1-1-修改配置-开启sentinel功能","children":[]},{"level":3,"title":"3.1.2.编写失败降级逻辑","slug":"_3-1-2-编写失败降级逻辑","link":"#_3-1-2-编写失败降级逻辑","children":[]},{"level":3,"title":"3.1.3.总结","slug":"_3-1-3-总结","link":"#_3-1-3-总结","children":[]}]},{"level":2,"title":"3.2.线程隔离（舱壁模式）","slug":"_3-2-线程隔离-舱壁模式","link":"#_3-2-线程隔离-舱壁模式","children":[{"level":3,"title":"3.2.1.线程隔离的实现方式","slug":"_3-2-1-线程隔离的实现方式","link":"#_3-2-1-线程隔离的实现方式","children":[]},{"level":3,"title":"3.2.2.sentinel的线程隔离","slug":"_3-2-2-sentinel的线程隔离","link":"#_3-2-2-sentinel的线程隔离","children":[]},{"level":3,"title":"3.2.3.总结","slug":"_3-2-3-总结","link":"#_3-2-3-总结","children":[]}]},{"level":2,"title":"3.3.熔断降级","slug":"_3-3-熔断降级","link":"#_3-3-熔断降级","children":[{"level":3,"title":"3.3.1.慢调用","slug":"_3-3-1-慢调用","link":"#_3-3-1-慢调用","children":[]},{"level":3,"title":"3.3.2.异常比例、异常数","slug":"_3-3-2-异常比例、异常数","link":"#_3-3-2-异常比例、异常数","children":[]}]},{"level":2,"title":"4.1.授权规则","slug":"_4-1-授权规则","link":"#_4-1-授权规则","children":[{"level":3,"title":"4.1.1.基本规则","slug":"_4-1-1-基本规则","link":"#_4-1-1-基本规则","children":[]},{"level":3,"title":"4.1.2.如何获取origin","slug":"_4-1-2-如何获取origin","link":"#_4-1-2-如何获取origin","children":[]},{"level":3,"title":"4.1.3.给网关添加请求头","slug":"_4-1-3-给网关添加请求头","link":"#_4-1-3-给网关添加请求头","children":[]},{"level":3,"title":"4.1.4.配置授权规则","slug":"_4-1-4-配置授权规则","link":"#_4-1-4-配置授权规则","children":[]}]},{"level":2,"title":"4.2.自定义异常结果","slug":"_4-2-自定义异常结果","link":"#_4-2-自定义异常结果","children":[{"level":3,"title":"4.2.1.异常类型","slug":"_4-2-1-异常类型","link":"#_4-2-1-异常类型","children":[]},{"level":3,"title":"4.2.2.自定义异常处理","slug":"_4-2-2-自定义异常处理","link":"#_4-2-2-自定义异常处理","children":[]}]},{"level":2,"title":"5.1.规则管理模式","slug":"_5-1-规则管理模式","link":"#_5-1-规则管理模式","children":[{"level":3,"title":"5.1.1.pull模式","slug":"_5-1-1-pull模式","link":"#_5-1-1-pull模式","children":[]},{"level":3,"title":"5.1.2.push模式","slug":"_5-1-2-push模式","link":"#_5-1-2-push模式","children":[]}]},{"level":2,"title":"5.2.实现push模式","slug":"_5-2-实现push模式","link":"#_5-2-实现push模式","children":[]}],"readingTime":{"minutes":30.21,"words":9063},"filePathRelative":"SpringCloud/高级/Sentinel/微服务保护.md","localizedDate":"2025年2月25日","excerpt":"\\n<h1>1.初识Sentinel</h1>\\n<h2>1.1.雪崩问题及解决方案</h2>\\n<h3>1.1.1.雪崩问题</h3>\\n<p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</p>\\n<figure><figcaption>1533829099748</figcaption></figure>\\n<p>如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。</p>\\n"}')}}]);