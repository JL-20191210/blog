---
title: 哪些垃圾回收阶段会 STW？
icon: fa-solid fa-hourglass-half
date: 2025-07-13
author: JeanHu
category:
  - JVM
  - GC机制
tag:
  - JVM
  - Stop The World
  - GC阶段
  - 回收器对比
summary: 本文总结了不同垃圾回收器中会触发 Stop The World（STW）的阶段，帮助读者理解各类 GC 策略下暂停的原理与行为特征，为调优 GC 停顿时间提供依据。
---


# ☕ JVM面试答题卡：哪些垃圾回收阶段会 STW？

> JVM 会在某些 GC 阶段**暂停所有用户线程（包括主线程）**，只运行 GC 线程。这种行为叫做 “Stop The World”。

------

## 📦 哪些垃圾回收阶段会 STW？

| 回收器         | GC 类型        | Stop The World 发生阶段                    |
| -------------- | -------------- | ------------------------------------------ |
| **Serial**     | Minor/Full     | ✅ 整个回收过程都会 STW（单线程回收）       |
| **Parallel**   | Minor/Full     | ✅ 整个回收过程 STW（多线程提升了回收速度） |
| **CMS**        | Minor          | ✅ 是（使用默认 `ParNew` 执行 Young GC）    |
|                | Major (老年代) | 部分阶段 STW（如初始标记、重新标记）       |
| **G1**         | Young          | ✅ 是（Young GC 是 STW 的）                 |
|                | Mixed/Major    | ✅ 初始标记和最终标记阶段 STW               |
| **ZGC**        | 并发回收       | ✅ 初始标记、最终标记 是 STW，但耗时非常短  |
| **Shenandoah** | 并发回收       | ✅ 初始标记、最终标记 是 STW，但延迟极小    |

------

## 🧩 分析：不同阶段是否 STW

对于多数回收器，以下两个阶段**几乎总是 STW**：

| 阶段名   | 是否 STW | 说明                                       |
| -------- | -------- | ------------------------------------------ |
| 初始标记 | ✅ 是     | 标记 GC Roots 直接可达对象，需暂停应用线程 |
| 最终标记 | ✅ 是     | 重新扫描标记遗漏的对象，确保准确性         |

对于 **Serial/Parallel** 收集器来说，整个回收过程都是 STW；
 对于 **CMS/G1/ZGC**，则优化了部分阶段为并发执行，但仍需 STW 开始或结束阶段。

------

## ✅ 举例：CMS 回收器 STW 阶段

CMS 分为多个阶段：

1. **初始标记**（STW ✅）
2. 并发标记（非 STW ❌）
3. 并发预清理（非 STW ❌）
4. **重新标记**（STW ✅）
5. 并发清理（非 STW ❌）
6. 重置（可能 STW）

------

## 🧠 小结：垃圾回收中的 STW 发生阶段

- ✅ 所有 GC 都在**初始标记**阶段 STW
- ✅ 几乎所有 GC 在**最终标记**阶段也会 STW
- ❌ ZGC、Shenandoah 等低延迟 GC 将其它阶段并发化
- ❌ CMS 除初始/重新标记外大多并发
- ❌ G1 除 initial/final mark 外，标记/回收都是并发

------

## 📚 补充建议

> 面试常问：“为什么 GC 会 Stop The World？是否可以避免？”

你可以回答：

> GC 为保证内存结构一致性，在标记活对象或移动对象时需要暂停应用线程，以避免并发修改产生的不一致性。现代 GC（如 ZGC、Shenandoah）通过并发标记与并发清理，显著缩短 STW 时间，提升响应性能。

