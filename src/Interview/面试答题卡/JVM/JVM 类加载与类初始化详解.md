# ☕ JVM面试答题卡：JVM 类加载与类初始化详解

## ✅ 一句话概括

> Java 类从编译后的 .class 文件被加载到 JVM 运行内存中，要经历类加载的五个阶段，最终在类初始化阶段执行 `<clinit>` 方法，完成静态变量赋值和静态语句块的执行。

## 🧱 1. JVM 类加载的五大阶段

```
加载 → 验证 → 准备 → 解析 → 初始化
```

| **阶段名** | **关键点**                               |
| ---------- | ---------------------------------------- |
| **加载**   | 读取 .class 文件并生成 Class 对象        |
| **验证**   | 确保字节码格式正确、符合规范（安全检查） |
| **准备**   | 为静态变量分配内存，赋默认值             |
| **解析**   | 将符号引用转为直接引用                   |
| **初始化** | 执行静态初始化代码 `<clinit>`            |

## ✅ 2. 类加载过程详解

### ✅ 2.1 加载（Loading）

- 通过类加载器读取 .class 文件，生成 java.lang.Class 对象
- 类加载器：启动类加载器（Bootstrap）、扩展类加载器（ExtClassLoader）、应用类加载器（AppClassLoader）等

### ✅ 2.2 验证（Verification）

- 检查字节码合法性（防止恶意攻击）
- 包括文件格式、元数据验证、语义验证、字节码验证等

### ✅ 2.3 准备（Preparation）

- 为**类的静态变量分配内存**，并赋**默认值**

```
public static int a = 10;
```

此阶段中 a 是 0，值尚未初始化为 10

### ✅ 2.4 解析（Resolution）

- 将符号引用（字符串或其他形式）转换为直接引用（内存地址/引用）
- 延迟解析：JVM 支持按需解析（运行时解析）

### ✅ 2.5 初始化（Initialization）

- **执行类中的静态变量赋值和静态代码块**（`<clinit>` 方法）
- 所有静态初始化逻辑在这里执行
- JVM 保证同一个类的 `<clinit>` 方法 **只会执行一次**

## ⚙️ 3. 什么时候会触发类初始化？

类初始化是类加载的最后一步，仅在**主动使用类**时才会触发，常见情况：

| **场景**                                             | **是否触发初始化**         |
| ---------------------------------------------------- | -------------------------- |
| new 对象                                             | ✅ 是                       |
| 访问静态变量（非 final）                             | ✅ 是                       |
| 调用静态方法                                         | ✅ 是                       |
| 反射（如 Class.forName）                             | ✅ 是                       |
| 子类初始化时，其父类会被初始化                       | ✅ 是                       |
| JVM 启动时主类                                       | ✅ 是                       |
| 访问静态常量（static final）                         | ❌ 不是（在准备阶段就完成） |
| 通过数组定义类（如 MyClass[] arr = new MyClass[10]） | ❌ 否                       |

## 🧪 4. 示例说明

```java
public class Demo {
    static {
        System.out.println("静态代码块执行");
    }

    static int a = 42;

    public static void method() {
        System.out.println("静态方法");
    }
}
public class Test {
    public static void main(String[] args) {
        Demo.method(); // 会触发类初始化，输出“静态代码块执行”
    }
}
```

## 🔍 5. 类加载器（ClassLoader）体系

| **类加载器**            | **加载内容**              |
| ----------------------- | ------------------------- |
| Bootstrap ClassLoader   | JDK 核心类（rt.jar）      |
| Extension ClassLoader   | ext 目录下的扩展类        |
| Application ClassLoader | 项目 classpath 中的类     |
| 自定义类加载器          | 通过继承 ClassLoader 实现 |

👉 类加载器遵循**双亲委派模型**

## 📚 6.clinit方法 VS 构造器

| **特性**   | `<clinit>` **静态初始化方法** | **构造器** Demo()        |
| ---------- | ----------------------------- | ------------------------ |
| 执行时机   | 类初始化阶段                  | 对象创建阶段（new）      |
| 执行次数   | 类加载后只执行一次            | 每次创建实例时执行       |
| 初始化内容 | 静态变量、静态代码块          | 普通成员变量、构造代码块 |

## ✅ 7. 面试高频问法与答题模板（建议背诵）

> Java 类的加载由 JVM 完成，分为五个阶段：加载、验证、准备、解析、初始化。类初始化阶段会执行 `<clinit>` 方法，对静态变量赋值并执行静态代码块。类只有在主动使用时才会触发初始化，如 new 对象、访问静态变量、调用静态方法等。JVM 中类加载器使用双亲委派模型，确保核心类安全不可被篡改。