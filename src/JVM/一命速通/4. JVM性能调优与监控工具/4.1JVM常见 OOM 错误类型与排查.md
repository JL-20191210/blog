---
title: 4.1 JVM å¸¸è§ OOM é”™è¯¯ç±»å‹ä¸æ’æŸ¥
icon: fa-solid fa-bug
date: 2025-07-10
author: JeanHu
category:
  - JVM
tag:
  - JVM
  - OOM
  - æ’æŸ¥
  - å†…å­˜æ³„æ¼
summary: æœ¬æ–‡æ¢³ç†äº† JVM ä¸­å¸¸è§çš„ OOMï¼ˆOutOfMemoryErrorï¼‰é”™è¯¯ç±»å‹ï¼Œç»“åˆå®é™…æ¡ˆä¾‹è¯¦è§£å†…å­˜æº¢å‡ºçš„æˆå› ã€è¯Šæ–­å·¥å…·ä¸æ’æŸ¥æ€è·¯ï¼Œå¸®åŠ©å¼€å‘è€…é«˜æ•ˆå®šä½å†…å­˜é—®é¢˜ã€‚
---
# ğŸ§¨ 4.1 JVM å¸¸è§ OOM é”™è¯¯ç±»å‹ä¸æ’æŸ¥

OutOfMemoryErrorï¼ˆOOMï¼‰æ˜¯ JVM ä¸­æœ€è‡´å‘½çš„è¿è¡Œæ—¶é”™è¯¯ä¹‹ä¸€ï¼Œç›´æ¥å½±å“ç³»ç»Ÿç¨³å®šæ€§ã€‚ä¸åŒç±»å‹çš„ OOM æŒ‡å‘ JVM å†…éƒ¨ä¸åŒçš„å†…å­˜åŒºåŸŸã€‚

------

<!-- more -->
## ğŸ’¥ OOM é”™è¯¯ç±»å‹æ€»è§ˆ

| é”™è¯¯ç±»å‹                              | å‡ºç°åœºæ™¯è¯´æ˜                                  |
| ------------------------------------- | --------------------------------------------- |
| Java heap space                       | å †å†…å­˜ä¸è¶³ï¼Œå¸¸å› å¯¹è±¡è¿‡å¤š/æœªåŠæ—¶å›æ”¶           |
| GC overhead limit exceeded            | GC æ—¶é—´å æ¯”è¿‡é«˜ï¼ˆ>98%ï¼‰ï¼Œå‡ ä¹æ— å¯å›æ”¶å†…å­˜     |
| Metaspace / PermGen space             | ç±»åŠ è½½å…ƒæ•°æ®ç©ºé—´ä¸è¶³ï¼ˆJDK 8 ä¹‹å‰ä¸º PermGenï¼‰  |
| Direct buffer memory                  | ç›´æ¥å†…å­˜æº¢å‡ºï¼Œå¦‚ NIO ByteBuffer æœªé‡Šæ”¾        |
| Requested array size exceeds VM limit | æ•°ç»„åˆ›å»ºè¿‡å¤§ï¼Œå¦‚ `new int[Integer.MAX_VALUE]` |
| Unable to create new native thread    | æœ¬åœ°çº¿ç¨‹æ•°è€—å°½ï¼Œæ— æ³•åˆ†é…æ–°çº¿ç¨‹                |

------

## ğŸ§ª å…¸å‹ç¤ºä¾‹ä¸é‡ç°

### 1. Java heap space

```java
List<byte[]> list = new ArrayList<>();
while (true) {
    list.add(new byte[1024 * 1024]); // æ¯æ¬¡ç”³è¯·1MB
}
```

é…ç½®ï¼š`-Xmx64m`ï¼Œè§¦å‘å †æº¢å‡º

------

### 2. GC overhead limit exceeded

```java
Map<String, String> map = new HashMap<>();
while (true) {
    map.put(UUID.randomUUID().toString(), "OOM");
}
```

GC è¶… 98% æ—¶é—´å›æ”¶ä¸åˆ° 2% çš„å †ï¼ŒJVM ä¿æŠ¤æ€§æŠ›å‡ºå¼‚å¸¸

------

### 3. Metaspaceï¼ˆJDK 8+ï¼‰

```java
while (true) {
    ClassPool pool = ClassPool.getDefault();
    CtClass cc = pool.makeClass(UUID.randomUUID().toString());
    cc.toClass(); // åŠ¨æ€ç”Ÿæˆç±»ï¼Œå¯¼è‡´å…ƒç©ºé—´è†¨èƒ€
}
```

é…ç½®ï¼š`-XX:MaxMetaspaceSize=64m`

------

### 4. Direct buffer memory

```java
while (true) {
    ByteBuffer buffer = ByteBuffer.allocateDirect(1024 * 1024);
    Thread.sleep(10);
}
```

é…ç½®ï¼š`-XX:MaxDirectMemorySize=64m`

------

## ğŸ” OOM é—®é¢˜æ’æŸ¥æ–¹æ³•

### âœ… 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—å †æ ˆ

- æ˜ç¡®æ˜¯å“ªç§ OOM é”™è¯¯
- æŸ¥çœ‹å¼‚å¸¸ç±»ã€ä»£ç ä½ç½®ã€çº¿ç¨‹å

### âœ… 2. ä½¿ç”¨å †è½¬å‚¨æ–‡ä»¶åˆ†æ

```bash
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/path/to/dump.hprof
```

ä½¿ç”¨å·¥å…·ï¼š`MAT`ã€`jvisualvm`ã€`GCEasy`

### âœ… 3. åˆ†æ GC æ—¥å¿—

ç»“åˆ `-Xlog:gc*` æˆ– `-XX:+PrintGCDetails` åˆ†æé¢‘ç¹ GC æƒ…å†µ

### âœ… 4. å®šä½çº¿ç¨‹/ç±»åŠ è½½/ç›´æ¥å†…å­˜é—®é¢˜

```bash
jmap -heap <pid>
jmap -clstats <pid>
jcmd <pid> VM.native_memory summary
ulimit -u   # æŸ¥çœ‹æœ€å¤§çº¿ç¨‹æ•°é™åˆ¶
```

------

## ğŸ›¡ï¸ å¸¸è§è§£å†³æ–¹æ¡ˆ

| ç±»å‹         | è§£å†³æ€è·¯                            |
| ------------ | ----------------------------------- |
| å †æº¢å‡º       | å¢åŠ  `-Xmx`ã€ä¼˜åŒ–ç¼“å­˜ã€æ’æŸ¥å†…å­˜æ³„æ¼ |
| GC overhead  | å‡å°‘å¯¹è±¡åˆ›å»ºã€è°ƒæ•´ GC ç­–ç•¥/æ™‹å‡è§„åˆ™ |
| Metaspace    | é™åˆ¶åŠ¨æ€ç±»ç”Ÿæˆï¼ˆå¦‚ Spring CGLIBï¼‰   |
| DirectMemory | é™åˆ¶ NIO ä½¿ç”¨ã€æ·»åŠ ä¸»åŠ¨é‡Šæ”¾é€»è¾‘     |
| æœ¬åœ°çº¿ç¨‹è€—å°½ | é™ä½çº¿ç¨‹æ± å¤§å°ã€æé«˜ ulimit é…ç½®    |

------

## ğŸ“ å°ç»“

- OOM é”™è¯¯æ¥æºå¤šæ ·ï¼Œå®šä½è¦ç»“åˆæ—¥å¿—ã€dump æ–‡ä»¶ã€GC è¡Œä¸ºåˆ†æ
- ä¸»åŠ¨å¼€å¯å †è½¬å‚¨ä¸ NMT æ˜¯ç”Ÿäº§ç³»ç»Ÿçš„å¿…å¤‡ä¿éšœ
- ä»£ç ä¸­è°¨æ…å¤„ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€åŠ¨æ€ç±»ã€çº¿ç¨‹ä¸ç¼“å†²åŒº

------

ğŸ‘‰ ä¸‹ä¸€ç¯‡æ¨èï¼š[4.2 å¦‚ä½•åˆ†æ Java å †è½¬å‚¨æ–‡ä»¶ï¼ˆhprofï¼‰](./4.2å¦‚ä½•åˆ†æ%20Java%20å †è½¬å‚¨æ–‡ä»¶ï¼ˆhprofï¼‰.md)