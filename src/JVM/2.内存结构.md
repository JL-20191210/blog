# 内存结构

## 1.程序计数器

### 1.1 定义

> Program Counter Register 程序计数器（寄存器）
> 作用：是记录下一条 jvm 指令的执行地址行号。

**特点**

- 是线程私有的
- 不会存在内存溢出

### 1.2 **作用**

- 程序计数器是`线程私有`的，每个线程都有自己的程序计数器。
- 在多线程环境下，程序计数器用于记录当前线程执行的字节码指令的地址，以支持线程切换后能够恢复到正确的执行位置。

### 1.3 **特点**

- 程序计数器是JVM中唯一一个在`多线程间不共享`的内存区域。
- 如果当前线程执行的是Java方法，程序计数器记录的是正在执行的虚拟机字节码指令地址；如果执行的是Native方法，计数器的值为undefined。

### 1.4 **内存结构**

- 程序计数器是线程私有的，是线程内部的数据结构，不会发生内存溢出。
- 程序计数器是一个较小的内存区域，通常大小为一个机器字长（例如32位或64位）。

### 1.5 **线程切换**

- 程序计数器在线程切换时起到重要作用，可以确保线程切换后能够恢复到正确的执行位置。
- 在线程执行过程中，程序计数器会被不断更新，记录当前执行的字节码指令地址。

### 1.6 **异常情况**

- 程序计数器在Java虚拟机规范中没有规定任何OutOfMemoryError情况。
- 程序计数器是线程私有的，不会发生线程安全问题。

## 2.虚拟机栈

### 1.1 **虚拟机栈**

- **定义**：
  - 每个线程运行所需的内存空间称为虚拟机栈。
  - 每个栈由多个栈帧（Frame）组成，对应每次方法调用所占用的内存。
- **特点**：
  - 栈大小可调整，超出限制会导致StackOverflowError。
  - 可能动态扩展，但无法动态收缩。
- **内存结构**：
  - 包含多个栈帧，每个对应一个方法的执行。
  - 栈帧包括局部变量表、操作数栈、动态链接、方法出口等信息。
- **线程切换**：
  - 在线程切换时起到关键作用，确保正确恢复执行位置。
  - 每个线程有独立虚拟机栈，保证数据隔离。
- **异常情况**：
  - 可出现StackOverflowError，栈空间不足时抛出。
  - 线程私有，不会导致线程安全问题.

### 1.2 **问题辨析**

- 垃圾回收
  - 不涉及栈内存，方法调用结束后栈弹出。
- 栈内存分配
  - 不是越大越好，大栈支持更多递归调用但减少可执行线程数。
- 局部变量线程安全性
  - 作用域内不逃离是安全的，否则需考虑线程安全。

### 1.3 **栈内存溢出**

- 原因包括栈帧过大、过多或第三方操作，可使用`-Xss256k`指定栈大小。

### 1.4 **线程运行诊断**

- 案例一：CPU 占用过多
  - 解决方法
    1. 使用`top`查看占用CPU高的进程。
    2. 通过`ps`查看哪个线程占用CPU高。
    3. 使用`jstack`查看线程NID，定位具体线程。
